<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Player Stats ‚Äî Revolution Rumble</title>
        <meta name="description" content="View and manage your bowler profile and tournament statistics."/>
        <link rel="stylesheet" href="static/css/packages/navbar.css" />
        <link rel="stylesheet" href="static/css/packages/presets.css" />
        <style>
            body {
                background: var(--black);
                color: var(--text);
                margin: 0;
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", 'Helvetica Neue', Arial;
            }

            .page-header {
                padding: 60px 0 40px;
                text-align: center;
                background: linear-gradient(180deg, var(--grey-900), var(--black));
            }

            .page-header h1 {
                font-size: clamp(2.5rem, 5vw, 4rem);
                margin: 0 0 12px;
                font-weight: 800;
            }

            .page-header p {
                color: var(--muted);
                font-size: 1.1rem;
                margin: 0;
            }

            .container.wide {
                max-width: 1400px;
            }

            .layout-grid {
                display: grid;
                grid-template-columns: 350px 1fr;
                gap: 24px;
                align-items: start;
            }

            .card {
                background: linear-gradient(180deg, var(--grey-800), var(--grey-700));
                border: 1px solid var(--grey-600);
                border-radius: 16px;
                padding: 32px;
                margin-bottom: 24px;
                box-shadow: 0 4px 12px rgba(0,0,0,.3);
            }

            .email-form {
                text-align: center;
                max-width: 500px;
                margin: 0 auto;
            }

            .email-form input {
                width: 100%;
                padding: 14px;
                font-size: 1rem;
                border: 1px solid var(--grey-600);
                border-radius: 8px;
                background: var(--grey-900);
                color: var(--text);
                margin-bottom: 12px;
            }

            .email-form button {
                width: 100%;
                padding: 14px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--blue-500);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all .2s;
            }

            .email-form button:hover {
                background: var(--blue-600);
            }

            .profile-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 24px;
                flex-wrap: wrap;
                gap: 16px;
            }

            .profile-info h2 {
                font-size: 1.8rem;
                margin: 0 0 8px;
            }

            .profile-nickname {
                color: var(--muted);
                font-size: 1.1rem;
                margin-bottom: 8px;
            }

            .profile-meta {
                display: flex;
                gap: 16px;
                flex-wrap: wrap;
                font-size: .9rem;
                color: var(--muted);
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin: 24px 0;
            }

            .stat-box {
                background: rgba(46, 143, 220, .1);
                border: 1px solid rgba(46, 143, 220, .3);
                padding: 16px;
                border-radius: 8px;
                text-align: center;
            }

            .stat-value {
                font-size: 2rem;
                font-weight: 700;
                color: var(--blue-500);
            }

            .stat-label {
                font-size: .85rem;
                color: var(--muted);
                text-transform: uppercase;
                letter-spacing: .5px;
            }

            .edit-form {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 16px;
            }

            .form-group {
                display: flex;
                flex-direction: column;
            }

            .form-group label {
                margin-bottom: 6px;
                font-size: .9rem;
                font-weight: 500;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px 12px;
                border: 1px solid var(--grey-600);
                border-radius: 6px;
                background: var(--grey-900);
                color: var(--text);
                font-size: .95rem;
            }

            .form-group textarea {
                min-height: 80px;
                resize: vertical;
            }

            .form-group.full-width {
                grid-column: 1 / -1;
            }

            .btn {
                padding: 12px 24px;
                font-size: .95rem;
                font-weight: 600;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all .2s;
            }

            .btn-primary {
                background: var(--blue-500);
                color: white;
            }

            .btn-primary:hover {
                background: var(--blue-600);
            }

            .btn-secondary {
                background: var(--grey-700);
                color: var(--text);
                border: 1px solid var(--grey-600);
            }

            .btn-secondary:hover {
                background: var(--grey-600);
            }

            .tournament-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .tournament-item {
                padding: 16px;
                border-bottom: 1px solid rgba(255,255,255,.05);
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 12px;
            }

            .tournament-item:last-child {
                border-bottom: none;
            }

            .tournament-name {
                font-weight: 600;
                margin-bottom: 4px;
            }

            .tournament-date {
                font-size: .85rem;
                color: var(--muted);
            }

            .tournament-score {
                text-align: right;
            }

            .score-value {
                font-size: 1.2rem;
                font-weight: 700;
                color: var(--blue-500);
            }

            .score-label {
                font-size: .75rem;
                color: var(--muted);
            }

            .status-badge {
                padding: 4px 10px;
                border-radius: 4px;
                font-size: .75rem;
                font-weight: 600;
                text-transform: uppercase;
            }

            .status-registered {
                background: rgba(255, 193, 7, .2);
                border: 1px solid rgba(255, 193, 7, .4);
                color: #ffc107;
            }

            .message {
                padding: 12px 16px;
                border-radius: 8px;
                margin: 16px 0;
                font-size: .9rem;
            }

            .message-success {
                background: rgba(46, 204, 113, .2);
                border: 1px solid rgba(46, 204, 113, .3);
                color: #51cf66;
            }

            .message-error {
                background: rgba(220, 53, 69, .2);
                border: 1px solid rgba(220, 53, 69, .3);
                color: #ff6b6b;
            }

            .empty-state {
                text-align: center;
                padding: 40px 20px;
                color: var(--muted);
            }

            .search-filter {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-bottom: 20px;
            }

            .search-filter input,
            .search-filter select {
                padding: 10px 12px;
                border: 1px solid var(--grey-600);
                border-radius: 6px;
                background: var(--grey-900);
                color: var(--text);
                font-size: .9rem;
            }

            .bowler-list {
                list-style: none;
                padding: 0;
                margin: 0;
                max-height: 600px;
                overflow-y: auto;
            }

            .bowler-card {
                padding: 14px;
                border-bottom: 1px solid rgba(255,255,255,.05);
                cursor: pointer;
                transition: all .2s;
            }

            .bowler-card:hover {
                background: rgba(46, 143, 220, .05);
                border-left: 3px solid var(--blue-500);
            }

            .bowler-card.active {
                background: rgba(46, 143, 220, .1);
                border-left: 3px solid var(--blue-500);
            }

            .bowler-card-name {
                font-weight: 600;
                margin-bottom: 4px;
            }

            .bowler-card-stats {
                display: flex;
                gap: 12px;
                font-size: .85rem;
                color: var(--muted);
            }

            .claim-profile-btn {
                width: 100%;
                margin-top: 16px;
                padding: 10px;
                background: rgba(255, 193, 7, .2);
                border: 1px solid rgba(255, 193, 7, .4);
                color: #ffc107;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                transition: all .2s;
            }

            .claim-profile-btn:hover {
                background: rgba(255, 193, 7, .3);
            }

            @media (max-width: 1024px) {
                .layout-grid {
                    grid-template-columns: 1fr;
                }
            }

            @media (max-width: 768px) {
                .profile-header {
                    flex-direction: column;
                }
            }
        </style>
    </head>
    <body>
        <special-header></special-header>

        <div class="page-header">
            <h1>Player Stats</h1>
            <p id="subtitle">Browse bowler profiles and tournament statistics</p>
        </div>

        <main class="container wide">
            <!-- Directory View (default) -->
            <div id="directory-section">
                <div class="layout-grid">
                    <!-- Left Sidebar - Bowler List -->
                    <div class="card">
                        <h3 style="margin-top:0">Bowlers</h3>
                        <div class="search-filter">
                            <input 
                                type="text" 
                                id="search-input" 
                                placeholder="Search by name..."
                                oninput="filterBowlers()"
                            />
                            <select id="sort-select" onchange="loadBowlers()">
                                <option value="avg-desc">Highest Average</option>
                                <option value="avg-asc">Lowest Average</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="tournaments-desc">Most Tournaments</option>
                            </select>
                            <select id="hand-filter" onchange="filterBowlers()">
                                <option value="all">All Hands</option>
                                <option value="right">Right Hand</option>
                                <option value="left">Left Hand</option>
                                <option value="both">Both Hands</option>
                            </select>
                        </div>
                        <ul class="bowler-list" id="bowler-list"></ul>
                    </div>

                    <!-- Right Side - Profile Display -->
                    <div id="profile-display-section">
                        <div class="card" style="text-align:center;padding:60px 20px;color:var(--muted)">
                            <div style="font-size:3rem;margin-bottom:16px">üëà</div>
                            <h3>Select a Bowler</h3>
                            <p>Choose a bowler from the list to view their profile and stats</p>
                            <button class="btn btn-primary" onclick="showClaimForm()" style="margin-top:20px">
                                Claim Your Profile
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section (shown when bowler selected or URL param) -->
            <div id="profile-section" style="display:none">
                <!-- Profile Display -->
                <div id="profile-display" class="card">
                    <div class="profile-header">
                        <div class="profile-info">
                            <h2 id="display-name"></h2>
                            <div class="profile-nickname" id="display-nickname"></div>
                            <div class="profile-meta">
                                <span id="display-email"></span>
                                <span id="display-hand"></span>
                                <span id="display-experience"></span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="toggleEditMode()">Edit Profile</button>
                    </div>

                    <div id="display-bio"></div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="stat-tournament-avg">--</div>
                            <div class="stat-label">Tournament Avg</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-current-avg">--</div>
                            <div class="stat-label">Current Avg</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-high-game">--</div>
                            <div class="stat-label">High Game</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-tournaments">0</div>
                            <div class="stat-label">Tournaments</div>
                        </div>
                    </div>
                </div>

                <!-- Edit Form (hidden initially) -->
                <div id="edit-form" class="card" style="display:none">
                    <h3 style="margin-top:0">Edit Profile</h3>
                    <form onsubmit="saveProfile(event)" class="edit-form">
                        <div class="form-group">
                            <label for="edit-nickname">Nickname</label>
                            <input type="text" id="edit-nickname" placeholder="Optional nickname" />
                        </div>

                        <div class="form-group">
                            <label for="edit-hand">Bowling Hand</label>
                            <select id="edit-hand">
                                <option value="">Not specified</option>
                                <option value="right">Right</option>
                                <option value="left">Left</option>
                                <option value="both">Both</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="edit-home-center">Home Center</label>
                            <input type="text" id="edit-home-center" placeholder="Your home bowling center" />
                        </div>

                        <div class="form-group">
                            <label for="edit-years">Years Experience</label>
                            <input type="number" id="edit-years" min="0" max="100" />
                        </div>

                        <div class="form-group">
                            <label for="edit-current-avg">Current Average</label>
                            <input type="number" id="edit-current-avg" min="0" max="300" />
                        </div>

                        <div class="form-group">
                            <label for="edit-high-game">High Game</label>
                            <input type="number" id="edit-high-game" min="0" max="300" />
                        </div>

                        <div class="form-group">
                            <label for="edit-high-series">High Series</label>
                            <input type="number" id="edit-high-series" min="0" max="900" />
                        </div>

                        <div class="form-group full-width">
                            <label for="edit-bio">Bio</label>
                            <textarea id="edit-bio" placeholder="Tell us about yourself..."></textarea>
                        </div>

                        <div class="form-group full-width" style="display:flex;gap:12px">
                            <button type="submit" class="btn btn-primary" style="flex:1">Save Changes</button>
                            <button type="button" class="btn btn-secondary" onclick="toggleEditMode()">Cancel</button>
                        </div>
                    </form>
                    <div id="edit-message"></div>
                </div>

                <!-- Tournament History -->
                <div class="card">
                    <h3 style="margin-top:0">Tournament History</h3>
                    <ul class="tournament-list" id="tournament-history"></ul>
                </div>
            </div>
        </main>

        <special-footer></special-footer>

        <script src="js/global/headerfooter.js"></script>
        <script src="js/global/navbar.js"></script>
        <script>
            let currentBowler = null;
            let allBowlers = [];
            let canEdit = false;

            // Initialize on page load
            async function init() {
                // Check if we have a bowler ID in URL
                const urlParams = new URLSearchParams(window.location.search);
                const bowlerId = urlParams.get('id');
                
                if (bowlerId) {
                    await loadBowlerById(bowlerId);
                } else {
                    await loadBowlers();
                }
            }

            // Load all bowlers for directory
            async function loadBowlers() {
                try {
                    const sortBy = document.getElementById('sort-select').value;
                    const response = await fetch('/api/bowlers');
                    allBowlers = await response.json();
                    
                    // Sort bowlers
                    if (sortBy === 'avg-desc') {
                        allBowlers.sort((a, b) => (b.tournamentAverage || b.currentAverage || 0) - (a.tournamentAverage || a.currentAverage || 0));
                    } else if (sortBy === 'avg-asc') {
                        allBowlers.sort((a, b) => (a.tournamentAverage || a.currentAverage || 0) - (b.tournamentAverage || b.currentAverage || 0));
                    } else if (sortBy === 'name-asc') {
                        allBowlers.sort((a, b) => a.playerName.localeCompare(b.playerName));
                    } else if (sortBy === 'tournaments-desc') {
                        allBowlers.sort((a, b) => (b.tournamentsEntered?.length || 0) - (a.tournamentsEntered?.length || 0));
                    }
                    
                    filterBowlers();
                } catch (error) {
                    console.error('Error loading bowlers:', error);
                }
            }

            // Filter and display bowlers
            function filterBowlers() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const handFilter = document.getElementById('hand-filter').value;
                
                const filtered = allBowlers.filter(b => {
                    const matchesSearch = b.playerName.toLowerCase().includes(searchTerm) || 
                                         (b.nickname && b.nickname.toLowerCase().includes(searchTerm));
                    const matchesHand = handFilter === 'all' || b.hand === handFilter;
                    return matchesSearch && matchesHand;
                });
                
                renderBowlerList(filtered);
            }

            // Render bowler list
            function renderBowlerList(bowlers) {
                const listEl = document.getElementById('bowler-list');
                
                if (bowlers.length === 0) {
                    listEl.innerHTML = '<li class="empty-state">No bowlers found</li>';
                    return;
                }
                
                listEl.innerHTML = bowlers.map(b => {
                    const avg = b.tournamentAverage || b.currentAverage || '--';
                    const tournaments = b.tournamentsEntered?.length || 0;
                    const isActive = currentBowler && currentBowler._id === b._id;
                    
                    return `
                        <li class="bowler-card ${isActive ? 'active' : ''}" onclick="selectBowler('${b._id}')">
                            <div class="bowler-card-name">
                                ${b.playerName}${b.nickname ? ` "${b.nickname}"` : ''}
                            </div>
                            <div class="bowler-card-stats">
                                <span>Avg: ${avg}</span>
                                <span>‚Ä¢</span>
                                <span>${tournaments} tournament${tournaments !== 1 ? 's' : ''}</span>
                            </div>
                        </li>
                    `;
                }).join('');
            }

            // Select bowler from list
            async function selectBowler(bowlerId) {
                await loadBowlerById(bowlerId);
                // Update URL without reload
                window.history.pushState({}, '', `/playerstats?id=${bowlerId}`);
            }

            // Load specific bowler by ID
            async function loadBowlerById(bowlerId) {
                try {
                    const response = await fetch(`/api/bowlers/${bowlerId}`);
                    if (!response.ok) throw new Error('Bowler not found');
                    
                    currentBowler = await response.json();
                    canEdit = false; // Public view by default
                    await loadHistory();
                    displayProfile();
                    
                    // Update active state in list
                    filterBowlers();
                } catch (error) {
                    console.error('Error loading bowler:', error);
                    alert('Failed to load bowler profile');
                }
            }

            // Show claim profile form
            function showClaimForm() {
                const profileSection = document.getElementById('profile-display-section');
                profileSection.innerHTML = `
                    <div class="card">
                        <h2 style="margin-top:0">Claim Your Profile</h2>
                        <p style="color:var(--muted)">Enter your email address to find and edit your bowler profile.</p>
                        <div class="email-form">
                            <input 
                                type="email" 
                                id="claim-email" 
                                placeholder="Enter your email address"
                                required
                            />
                            <button onclick="claimProfile()">Find My Profile</button>
                            <div id="claim-message"></div>
                        </div>
                        <button class="btn btn-secondary" onclick="init()" style="margin-top:16px">Cancel</button>
                    </div>
                `;
            }

            // Claim profile via email
            async function claimProfile() {
                const email = document.getElementById('claim-email').value.trim();
                const messageDiv = document.getElementById('claim-message');
                messageDiv.innerHTML = '';

                if (!email) {
                    messageDiv.innerHTML = '<div class="message message-error">Please enter your email address</div>';
                    return;
                }

                try {
                    const response = await fetch(`/api/bowlers/lookup?email=${encodeURIComponent(email)}`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            messageDiv.innerHTML = '<div class="message message-error">No profile found. Register for a tournament to create your profile!</div>';
                        } else {
                            throw new Error('Failed to lookup profile');
                        }
                        return;
                    }

                    currentBowler = await response.json();
                    canEdit = true; // Enable editing
                    await loadHistory();
                    displayProfile();
                    
                    window.history.pushState({}, '', `/playerstats?id=${currentBowler._id}`);
                } catch (error) {
                    console.error('Lookup error:', error);
                    messageDiv.innerHTML = '<div class="message message-error">Error loading profile. Please try again.</div>';
                }
            }

            async function loadHistory() {
                try {
                    const response = await fetch(`/api/bowlers/${currentBowler._id}/history`);
                    const data = await response.json();
                    
                    const historyList = document.getElementById('tournament-history');
                    
                    if (data.registrations.length === 0) {
                        historyList.innerHTML = '<li class="empty-state">No tournament registrations yet</li>';
                        return;
                    }

                    historyList.innerHTML = data.registrations.map(reg => {
                        const date = new Date(reg.tournament.date);
                        const dateStr = date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });

                        // Find matching result
                        const result = data.results.find(r => r.tournament._id === reg.tournament._id);
                        
                        return `
                            <li class="tournament-item">
                                <div>
                                    <div class="tournament-name">${reg.tournament.name}</div>
                                    <div class="tournament-date">${dateStr} ‚Ä¢ ${reg.tournament.location}</div>
                                </div>
                                ${result ? `
                                    <div class="tournament-score">
                                        <div class="score-value">${result.tournamentAverage}</div>
                                        <div class="score-label">Average (${result.totalGames} games)</div>
                                    </div>
                                ` : `
                                    <span class="status-badge status-registered">Registered</span>
                                `}
                            </li>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error loading history:', error);
                }
            }

            function displayProfile() {
                // Hide directory, show profile section
                document.getElementById('directory-section').style.display = 'none';
                document.getElementById('profile-section').style.display = 'block';
                
                // Render profile HTML
                const profileSection = document.getElementById('profile-section');
                profileSection.innerHTML = `
                    <button class="btn btn-secondary" onclick="backToDirectory()" style="margin-bottom:16px">
                        ‚Üê Back to Directory
                    </button>
                    
                    <!-- Profile Display -->
                    <div id="profile-display" class="card">
                        <div class="profile-header">
                            <div class="profile-info">
                                <h2>${currentBowler.playerName}</h2>
                                <div class="profile-nickname">${currentBowler.nickname ? `"${currentBowler.nickname}"` : ''}</div>
                                <div class="profile-meta">
                                    <span>${currentBowler.email}</span>
                                    ${currentBowler.hand ? `<span>üé≥ ${currentBowler.hand.charAt(0).toUpperCase() + currentBowler.hand.slice(1)} hand</span>` : ''}
                                    ${currentBowler.yearsExperience ? `<span>üìÖ ${currentBowler.yearsExperience} years experience</span>` : ''}
                                    ${currentBowler.homeCenter ? `<span>üè† ${currentBowler.homeCenter}</span>` : ''}
                                </div>
                            </div>
                            ${canEdit ? '<button class="btn btn-secondary" onclick="toggleEditMode()">Edit Profile</button>' : '<button class="claim-profile-btn" onclick="showClaimForm()">Is this you? Claim this profile</button>'}
                        </div>

                        ${currentBowler.bio ? `<p style="color:var(--muted);margin-top:16px">${currentBowler.bio}</p>` : ''}

                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value">${currentBowler.tournamentAverage || '--'}</div>
                                <div class="stat-label">Tournament Avg</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${currentBowler.currentAverage || '--'}</div>
                                <div class="stat-label">Current Avg</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${currentBowler.highGame || '--'}</div>
                                <div class="stat-label">High Game</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${currentBowler.tournamentsEntered?.length || '0'}</div>
                                <div class="stat-label">Tournaments</div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Form (hidden initially) -->
                    <div id="edit-form" class="card" style="display:none">
                        <h3 style="margin-top:0">Edit Profile</h3>
                        <form onsubmit="saveProfile(event)" class="edit-form">
                            <div class="form-group">
                                <label for="edit-nickname">Nickname</label>
                                <input type="text" id="edit-nickname" placeholder="Optional nickname" value="${currentBowler.nickname || ''}" />
                            </div>

                            <div class="form-group">
                                <label for="edit-hand">Bowling Hand</label>
                                <select id="edit-hand">
                                    <option value="" ${!currentBowler.hand ? 'selected' : ''}>Not specified</option>
                                    <option value="right" ${currentBowler.hand === 'right' ? 'selected' : ''}>Right</option>
                                    <option value="left" ${currentBowler.hand === 'left' ? 'selected' : ''}>Left</option>
                                    <option value="both" ${currentBowler.hand === 'both' ? 'selected' : ''}>Both</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="edit-home-center">Home Center</label>
                                <input type="text" id="edit-home-center" placeholder="Your home bowling center" value="${currentBowler.homeCenter || ''}" />
                            </div>

                            <div class="form-group">
                                <label for="edit-years">Years Experience</label>
                                <input type="number" id="edit-years" min="0" max="100" value="${currentBowler.yearsExperience || ''}" />
                            </div>

                            <div class="form-group">
                                <label for="edit-current-avg">Current Average</label>
                                <input type="number" id="edit-current-avg" min="0" max="300" value="${currentBowler.currentAverage || ''}" />
                            </div>

                            <div class="form-group">
                                <label for="edit-high-game">High Game</label>
                                <input type="number" id="edit-high-game" min="0" max="300" value="${currentBowler.highGame || ''}" />
                            </div>

                            <div class="form-group">
                                <label for="edit-high-series">High Series</label>
                                <input type="number" id="edit-high-series" min="0" max="900" value="${currentBowler.highSeries || ''}" />
                            </div>

                            <div class="form-group full-width">
                                <label for="edit-bio">Bio</label>
                                <textarea id="edit-bio" placeholder="Tell us about yourself...">${currentBowler.bio || ''}</textarea>
                            </div>

                            <div class="form-group full-width" style="display:flex;gap:12px">
                                <button type="submit" class="btn btn-primary" style="flex:1">Save Changes</button>
                                <button type="button" class="btn btn-secondary" onclick="toggleEditMode()">Cancel</button>
                            </div>
                        </form>
                        <div id="edit-message"></div>
                    </div>

                    <!-- Tournament History -->
                    <div class="card">
                        <h3 style="margin-top:0">Tournament History</h3>
                        <ul class="tournament-list" id="tournament-history"></ul>
                    </div>
                `;
                
                // Load tournament history after rendering
                setTimeout(() => loadHistory(), 100);
            }

            function backToDirectory() {
                document.getElementById('directory-section').style.display = 'block';
                document.getElementById('profile-section').style.display = 'none';
                window.history.pushState({}, '', '/playerstats');
                currentBowler = null;
                canEdit = false;
            }

            function toggleEditMode() {
                const display = document.getElementById('profile-display');
                const editForm = document.getElementById('edit-form');
                
                if (editForm.style.display === 'none') {
                    // Populate edit form
                    document.getElementById('edit-nickname').value = currentBowler.nickname || '';
                    document.getElementById('edit-hand').value = currentBowler.hand || '';
                    document.getElementById('edit-home-center').value = currentBowler.homeCenter || '';
                    document.getElementById('edit-years').value = currentBowler.yearsExperience || '';
                    document.getElementById('edit-current-avg').value = currentBowler.currentAverage || '';
                    document.getElementById('edit-high-game').value = currentBowler.highGame || '';
                    document.getElementById('edit-high-series').value = currentBowler.highSeries || '';
                    document.getElementById('edit-bio').value = currentBowler.bio || '';
                    
                    display.style.display = 'none';
                    editForm.style.display = 'block';
                } else {
                    display.style.display = 'block';
                    editForm.style.display = 'none';
                    document.getElementById('edit-message').innerHTML = '';
                }
            }

            async function saveProfile(event) {
                event.preventDefault();
                const messageDiv = document.getElementById('edit-message');
                messageDiv.innerHTML = '';

                const updatedData = {
                    email: currentBowler.email, // Required for verification
                    nickname: document.getElementById('edit-nickname').value,
                    hand: document.getElementById('edit-hand').value,
                    homeCenter: document.getElementById('edit-home-center').value,
                    yearsExperience: document.getElementById('edit-years').value ? parseInt(document.getElementById('edit-years').value) : undefined,
                    currentAverage: document.getElementById('edit-current-avg').value ? parseInt(document.getElementById('edit-current-avg').value) : undefined,
                    highGame: document.getElementById('edit-high-game').value ? parseInt(document.getElementById('edit-high-game').value) : undefined,
                    highSeries: document.getElementById('edit-high-series').value ? parseInt(document.getElementById('edit-high-series').value) : undefined,
                    bio: document.getElementById('edit-bio').value
                };

                try {
                    const response = await fetch(`/api/bowlers/${currentBowler._id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update profile');
                    }

                    currentBowler = await response.json();
                    displayProfile();
                    
                    const messageDiv = document.getElementById('edit-message');
                    messageDiv.innerHTML = '<div class="message message-success">‚úÖ Profile updated successfully!</div>';
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                        toggleEditMode();
                    }, 2000);
                } catch (error) {
                    console.error('Save error:', error);
                    const messageDiv = document.getElementById('edit-message');
                    messageDiv.innerHTML = '<div class="message message-error">‚ùå Failed to save changes. Please try again.</div>';
                }
            }

            // Initialize on page load
            init();
        </script>
    </body>
</html>
