<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Squad Lists ‚Äî Revolution Rumble</title>
        <meta name="description" content="View tournament squad lists and registrations."/>
        <link rel="stylesheet" href="static/css/packages/navbar.css" />
        <link rel="stylesheet" href="static/css/packages/presets.css" />
        <style>
            body {
                background: var(--black);
                color: var(--text);
                margin: 0;
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", 'Helvetica Neue', Arial;
            }

            .page-header {
                padding: 60px 0 40px;
                text-align: center;
                background: linear-gradient(180deg, var(--grey-900), var(--black));
            }

            .page-header h1 {
                font-size: clamp(2.5rem, 5vw, 4rem);
                margin: 0 0 12px;
                font-weight: 800;
            }

            .page-header p {
                color: var(--muted);
                font-size: 1.1rem;
                margin: 0;
            }

            .container {
                max-width: 1200px;
                margin: 40px auto;
                padding: 0 20px;
            }

            .tournament-info {
                background: linear-gradient(180deg, var(--grey-800), var(--grey-700));
                border: 1px solid var(--grey-600);
                border-radius: 16px;
                padding: 32px;
                margin-bottom: 32px;
                box-shadow: 0 4px 12px rgba(0,0,0,.3);
            }

            .tournament-info h2 {
                font-size: 1.8rem;
                margin: 0 0 12px;
            }

            .tournament-meta {
                display: flex;
                gap: 20px;
                color: var(--muted);
                font-size: .95rem;
                flex-wrap: wrap;
            }

            .meta-item {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .squads-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
                gap: 24px;
                margin-bottom: 40px;
            }

            .squad-card {
                background: linear-gradient(180deg, var(--grey-800), var(--grey-700));
                border: 1px solid var(--grey-600);
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,.2);
            }

            .squad-header {
                border-bottom: 1px solid var(--grey-600);
                padding-bottom: 16px;
                margin-bottom: 16px;
            }

            .squad-title {
                font-size: 1.4rem;
                margin: 0 0 8px;
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
            }

            .qualifying-badge {
                background: rgba(46, 204, 113, .2);
                border: 1px solid rgba(46, 204, 113, .4);
                color: #51cf66;
                padding: 3px 10px;
                border-radius: 4px;
                font-size: .75rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: .5px;
            }

            .squad-details {
                display: flex;
                gap: 16px;
                font-size: .9rem;
                color: var(--muted);
                flex-wrap: wrap;
            }

            .capacity-info {
                background: rgba(46, 143, 220, .1);
                border: 1px solid rgba(46, 143, 220, .3);
                padding: 12px 16px;
                border-radius: 8px;
                margin-bottom: 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .capacity-info.full {
                background: rgba(220, 53, 69, .1);
                border-color: rgba(220, 53, 69, .3);
            }

            .capacity-label {
                font-size: .85rem;
                color: var(--muted);
            }

            .capacity-count {
                font-size: 1.3rem;
                font-weight: 700;
                color: var(--blue-500);
            }

            .capacity-info.full .capacity-count {
                color: #ff6b6b;
            }

            .bowlers-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .bowler-item {
                padding: 10px 12px;
                border-bottom: 1px solid rgba(255,255,255,.03);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .bowler-item:last-child {
                border-bottom: none;
            }

            .bowler-item:nth-child(odd) {
                background: rgba(255,255,255,.02);
            }

            .bowler-name {
                font-weight: 500;
            }

            .bowler-name a {
                color: var(--text);
                text-decoration: none;
                transition: color .2s;
            }

            .bowler-name a:hover {
                color: var(--blue-500);
            }

            .bowler-avg {
                color: var(--muted);
                font-size: .85rem;
            }

            .empty-squad {
                text-align: center;
                padding: 20px;
                color: var(--muted);
                font-style: italic;
            }

            .loading {
                text-align: center;
                padding: 60px 20px;
                color: var(--muted);
            }

            .error {
                text-align: center;
                padding: 60px 20px;
                color: #ff6b6b;
            }

            @media (max-width: 768px) {
                .squads-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <special-header></special-header>

        <div class="page-header">
            <h1>Squad Lists</h1>
            <p id="subtitle">Select a tournament to view squad registrations</p>
        </div>

        <main class="container">
            <div style="max-width:600px;margin:0 auto 32px">
                <label for="tournamentSelect" style="display:block;font-size:0.9rem;font-weight:600;margin-bottom:8px;color:#b9c6d8">Select Tournament</label>
                <select id="tournamentSelect" style="width:100%;padding:12px 16px;font-size:1rem;border-radius:8px;background:#141a22;border:1px solid rgba(255,255,255,0.1);color:#e9eef7;cursor:pointer;transition:all 0.2s">
                    <option value="">Choose a tournament...</option>
                </select>
            </div>
            
            <div id="tournament-info"></div>
            <div id="squads-container" class="loading">
                <p>Please select a tournament to view squad lists</p>
            </div>
        </main>

        <special-footer></special-footer>

        <script src="js/global/headerfooter.js"></script>
        <script src="js/global/navbar.js"></script>
        <script>
            const tournamentSelect = document.getElementById('tournamentSelect');
            
            async function loadTournaments() {
                try {
                    const response = await fetch('/api/tournaments');
                    const tournaments = await response.json();
                    
                    // Sort by date descending
                    tournaments.sort((a, b) => new Date(b.startDate || b.date) - new Date(a.startDate || a.date));
                    
                    tournamentSelect.innerHTML = '<option value="">Choose a tournament...</option>';
                    tournaments.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t._id;
                        const date = new Date(t.startDate || t.date).toLocaleDateString();
                        opt.textContent = `${t.name} - ${date}`;
                        tournamentSelect.appendChild(opt);
                    });
                    
                    // Check URL parameter for tournament ID
                    const urlParams = new URLSearchParams(window.location.search);
                    const tournamentId = urlParams.get('id');
                    if (tournamentId) {
                        tournamentSelect.value = tournamentId;
                        await loadSquads(tournamentId);
                    }
                } catch (error) {
                    console.error('Error loading tournaments:', error);
                }
            }
            
            tournamentSelect.addEventListener('change', async () => {
                const tournamentId = tournamentSelect.value;
                if (tournamentId) {
                    // Update URL
                    const url = new URL(window.location);
                    url.searchParams.set('id', tournamentId);
                    window.history.replaceState({}, '', url);
                    
                    await loadSquads(tournamentId);
                } else {
                    document.getElementById('tournament-info').innerHTML = '';
                    document.getElementById('squads-container').innerHTML = '<div class="loading"><p>Please select a tournament to view squad lists</p></div>';
                }
            });

            async function loadSquads(tournamentId) {
                try {
                    if (!tournamentId) {
                        document.getElementById('squads-container').innerHTML = '<div class="error">No tournament specified</div>';
                        return;
                    }

                    document.getElementById('squads-container').innerHTML = '<div class="loading"><p>Loading squad information...</p></div>';

                    const response = await fetch(`/api/tournaments/${tournamentId}/squads/list`);
                    if (!response.ok) {
                        throw new Error('Failed to load squad data');
                    }

                    const data = await response.json();
                    const { tournament, squads } = data;

                    // Update page title and subtitle
                    document.title = `${tournament.name} - Squad Lists ‚Äî Revolution Rumble`;
                    document.getElementById('subtitle').textContent = tournament.name;

                    // Display tournament info
                    const date = new Date(tournament.startDate || tournament.date);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });

                    document.getElementById('tournament-info').innerHTML = `
                        <div class="tournament-info">
                            <h2>${tournament.name}</h2>
                            <div class="tournament-meta">
                                <div class="meta-item">üìÖ ${formattedDate}</div>
                                <div class="meta-item">üìç ${tournament.location}</div>
                                ${tournament.squadsRequiredToQualify > 0 ? `<div class="meta-item">üéØ ${tournament.squadsRequiredToQualify} qualifying squad${tournament.squadsRequiredToQualify > 1 ? 's' : ''} required</div>` : ''}
                            </div>
                        </div>
                    `;

                    // Display squads
                    if (squads.length === 0) {
                        document.getElementById('squads-container').innerHTML = '<div class="empty-squad">No squads configured for this tournament</div>';
                        return;
                    }

                    document.getElementById('squads-container').innerHTML = `
                        <div class="squads-grid">
                            ${squads.map(squad => {
                                const isFull = squad.spotsRemaining <= 0;
                                const squadDate = new Date(squad.date);
                                const dateStr = squadDate.toLocaleDateString('en-US', { 
                                    weekday: 'short',
                                    month: 'short', 
                                    day: 'numeric' 
                                });

                                return `
                                    <div class="squad-card">
                                        <div class="squad-header">
                                            <div class="squad-title">
                                                ${squad.name}
                                                ${squad.isQualifying ? '<span class="qualifying-badge">QUALIFYING</span>' : ''}
                                            </div>
                                            <div class="squad-details">
                                                <span>üìÖ ${dateStr}</span>
                                                <span>‚è∞ ${squad.time}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="capacity-info${isFull ? ' full' : ''}">
                                            <span class="capacity-label">Registered / Capacity</span>
                                            <span class="capacity-count">${squad.bowlers.length} / ${squad.capacity}</span>
                                        </div>
                                        
                                        ${squad.bowlers.length > 0 ? `
                                            <ul class="bowlers-list">
                                                ${squad.bowlers.map(bowler => `
                                                    <li class="bowler-item">
                                                        <span class="bowler-name">
                                                            ${bowler.bowlerId ? `<a href="/playerstats?id=${bowler.bowlerId}">${bowler.name}</a>` : bowler.name}
                                                        </span>
                                                        ${bowler.averageScore ? `<span class="bowler-avg">Avg: ${bowler.averageScore}</span>` : ''}
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        ` : '<div class="empty-squad">No bowlers registered yet</div>'}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;

                } catch (error) {
                    console.error('Failed to load squads:', error);
                    document.getElementById('squads-container').innerHTML = '<div class="error">Failed to load squad information</div>';
                }
            }

            loadTournaments();
        </script>
    </body>
</html>
