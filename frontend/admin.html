<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Admin ‚Äî Revolution Rumble</title>
        <style>
            body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#070709;color:#e9eef7;margin:0}
            header{padding:14px 20px;background:#0f1520}
            .container{width:min(1100px,94%);margin:20px auto}
            .card{background:#0b0f14;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.03);margin-bottom:20px}
            .row{display:flex;gap:12px;align-items:center}
            .danger{background:#4a1919;color:#ffd8d8}
            a.button{display:inline-block;padding:8px 12px;background:#2e8fdc;color:white;border-radius:8px;text-decoration:none;border:none;cursor:pointer}
            button.button{display:inline-block;padding:8px 12px;background:#2e8fdc;color:white;border-radius:8px;text-decoration:none;border:none;cursor:pointer;font:inherit}
            button.button:hover,a.button:hover{background:#3a9fec}
            .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
            .form-group{display:flex;flex-direction:column;gap:4px}
            .form-group.full{grid-column:1/-1}
            label{font-size:.9rem;color:#b9c6d8}
            input,select,textarea{background:#141a22;border:1px solid rgba(255,255,255,.08);color:#e9eef7;padding:8px 10px;border-radius:6px;font:inherit}
            input:focus,select:focus,textarea:focus{outline:none;border-color:#2e8fdc}
            .tournament-list{display:grid;gap:10px;margin-top:12px}
            .tournament-item{background:#141a22;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.05);display:flex;justify-content:space-between;align-items:center}
            .tournament-info h4{margin:0 0 4px 0;font-size:1rem}
            .tournament-info p{margin:0;font-size:.85rem;color:#b9c6d8}
            .tournament-actions{display:flex;gap:8px}
            .btn-delete{background:#c92a2a;padding:6px 10px;border:none;color:white;border-radius:6px;cursor:pointer;font-size:.85rem}
            .btn-delete:hover{background:#e03131}
            .status-badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:.75rem;font-weight:600;text-transform:uppercase}
            .status-upcoming{background:rgba(46,143,220,.2);color:#5eb6f5}
            .status-ongoing{background:rgba(46,204,113,.2);color:#51cf66}
            .status-completed{background:rgba(134,142,150,.2);color:#adb5bd}
            @media(max-width:768px){.form-grid{grid-template-columns:1fr}}
        </style>
    </head>
    <body>
        <header>
            <div class="container row">
                <h1 style="margin:0;font-size:1.1rem">Admin Dashboard</h1>
                <div style="margin-left:auto"><a class="button" href="/admin/logout">Sign out</a></div>
            </div>
        </header>

        <main class="container">
            <div class="card">
                <h2 style="margin-top:0">Site administration</h2>
                <p class="muted">This is a lightweight admin dashboard. Add functionality as needed (manage entries, view logs, etc.).</p>
                <section style="margin-top:12px">
                    <h3>Actions</h3>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <a class="button" href="/results">Open Results page</a>
                        <a class="button" href="/playerstats">Player stats</a>
                    </div>
                </section>
            </div>

            <!-- Tournament Management -->
            <div class="card">
                <h2 style="margin-top:0">üèÜ Tournament Management</h2>
                
                <!-- Add/Edit Tournament Form -->
                <form id="tournamentForm">
                    <input type="hidden" id="editingTournamentId" value="">
                    <h3 id="formTitle" style="margin-bottom:16px">Add New Tournament</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">Tournament Name *</label>
                            <input type="text" id="name" name="name" required placeholder="Logan City Cup 2026">
                        </div>
                        <div class="form-group">
                            <label for="date">Date *</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="location">Location *</label>
                            <input type="text" id="location" name="location" required placeholder="Logan City Tenpin">
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status">
                                <option value="upcoming">Upcoming</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxParticipants">Max Participants</label>
                            <input type="number" id="maxParticipants" name="maxParticipants" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="registrationDeadline">Registration Deadline</label>
                            <input type="date" id="registrationDeadline" name="registrationDeadline">
                        </div>
                        <div class="form-group">
                            <label for="squadsRequiredToQualify">Squads Required to Qualify</label>
                            <input type="number" id="squadsRequiredToQualify" name="squadsRequiredToQualify" min="1" value="1">
                        </div>
                        <div class="form-group full">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="3" placeholder="Optional details about the tournament..."></textarea>
                        </div>
                    </div>

                    <!-- Squad Management -->
                    <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,.08)">
                        <h4 style="margin:0 0 12px 0">Squad Management</h4>
                        <div id="squadsList" style="display:grid;gap:10px;margin-bottom:12px"></div>
                        
                        <div style="background:#141a22;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.05)">
                            <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;align-items:end">
                                <div class="form-group" style="margin:0">
                                    <label style="font-size:.8rem">Squad Name</label>
                                    <input type="text" id="squadName" placeholder="Squad A" style="padding:6px 8px;font-size:.9rem">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="font-size:.8rem">Date</label>
                                    <input type="date" id="squadDate" style="padding:6px 8px;font-size:.9rem">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="font-size:.8rem">Time</label>
                                    <input type="time" id="squadTime" style="padding:6px 8px;font-size:.9rem">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="font-size:.8rem">Capacity</label>
                                    <input type="number" id="squadCapacity" min="1" placeholder="24" style="padding:6px 8px;font-size:.9rem">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="font-size:.8rem;display:flex;align-items:center;gap:4px">
                                        <input type="checkbox" id="squadIsQualifying" style="width:auto;margin:0">
                                        <span>Qualifying</span>
                                    </label>
                                </div>
                                <button type="button" class="button" onclick="addSquad()" style="padding:6px 12px;font-size:.85rem">Add Squad</button>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex;gap:8px;margin-top:16px">
                        <button type="submit" class="button" id="submitBtn">Add Tournament</button>
                        <button type="button" class="button" onclick="cancelEdit()" id="cancelBtn" style="display:none;background:#6c757d">Cancel Edit</button>
                    </div>
                </form>

                <!-- Tournament List -->
                <div style="margin-top:24px">
                    <h3 style="margin-bottom:12px">Scheduled Tournaments</h3>
                    <div id="tournamentList" class="tournament-list">
                        <p style="color:#b9c6d8;text-align:center">Loading tournaments...</p>
                    </div>
                </div>
            </div>

            <!-- Registration Management -->
            <div class="card">
                <h2 style="margin-top:0">üìã Registration Management</h2>
                
                <div class="form-group" style="margin-bottom:16px">
                    <label for="regTournamentFilter">Filter by Tournament</label>
                    <select id="regTournamentFilter" style="max-width:400px">
                        <option value="">All Tournaments</option>
                    </select>
                </div>

                <div style="margin-top:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
                    <h3 style="margin:0">Registrations (<span id="regCount">0</span>)</h3>
                    <div style="display:flex;gap:8px">
                        <button class="button" style="font-size:.85rem;padding:6px 12px" onclick="loadRegistrations()">Refresh</button>
                        <button class="button" style="font-size:.85rem;padding:6px 12px" onclick="exportRegistrations()">Export CSV</button>
                    </div>
                </div>

                <div id="registrationList" style="max-height:500px;overflow-y:auto">
                    <p style="color:#b9c6d8;text-align:center">Loading registrations...</p>
                </div>
            </div>
        </main>

        <script>
            const form = document.getElementById('tournamentForm');
            const listContainer = document.getElementById('tournamentList');
            const regListContainer = document.getElementById('registrationList');
            const regFilterSelect = document.getElementById('regTournamentFilter');
            const regCountSpan = document.getElementById('regCount');
            
            let currentSquads = [];

            // Load tournaments on page load
            loadTournaments();
            loadRegistrations();
            renderSquadsList(); // Initialize empty squad list

            // Handle form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const editingId = document.getElementById('editingTournamentId').value;
                const isEditing = !!editingId;
                
                const formData = {
                    name: form.name.value,
                    date: form.date.value,
                    location: form.location.value,
                    status: form.status.value,
                    description: form.description.value,
                    maxParticipants: form.maxParticipants.value ? Number(form.maxParticipants.value) : null,
                    registrationDeadline: form.registrationDeadline.value || null,
                    squadsRequiredToQualify: form.squadsRequiredToQualify.value ? Number(form.squadsRequiredToQualify.value) : 1,
                    squads: currentSquads.map(s => {
                        const squad = {
                            name: s.name,
                            date: s.date,
                            time: s.time,
                            capacity: s.capacity,
                            isQualifying: s.isQualifying
                        };
                        // Only include _id if it's a valid MongoDB ObjectId (24 hex characters)
                        if (s._id && s._id.length === 24 && /^[0-9a-fA-F]{24}$/.test(s._id)) {
                            squad._id = s._id;
                        }
                        return squad;
                    })
                };

                try {
                    const url = isEditing ? `/api/tournaments/${editingId}` : '/api/tournaments';
                    const method = isEditing ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        form.reset();
                        currentSquads = [];
                        renderSquadsList();
                        cancelEdit();
                        loadTournaments();
                        loadRegistrations();
                        alert(isEditing ? 'Tournament updated successfully!' : 'Tournament added successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + error.error);
                    }
                } catch (error) {
                    alert('Failed to save tournament: ' + error.message);
                }
            });

            // Squad management functions
            let editingSquadIndex = null;

            function addSquad() {
                const name = document.getElementById('squadName').value;
                const date = document.getElementById('squadDate').value;
                const time = document.getElementById('squadTime').value;
                const capacity = document.getElementById('squadCapacity').value;
                const isQualifying = document.getElementById('squadIsQualifying').checked;

                if (!name || !date || !time || !capacity) {
                    alert('Please fill in all squad fields');
                    return;
                }

                const squadData = {
                    name,
                    date,
                    time,
                    capacity: Number(capacity),
                    isQualifying
                };

                if (editingSquadIndex !== null) {
                    // Update existing squad
                    currentSquads[editingSquadIndex] = {
                        ...currentSquads[editingSquadIndex],
                        ...squadData
                    };
                    editingSquadIndex = null;
                    document.querySelector('#squadsList ~ div button[onclick="addSquad()"]').textContent = 'Add Squad';
                } else {
                    // Add new squad
                    squadData._id = Date.now().toString(); // Temporary ID for new squads
                    currentSquads.push(squadData);
                }

                // Clear inputs
                document.getElementById('squadName').value = '';
                document.getElementById('squadDate').value = '';
                document.getElementById('squadTime').value = '';
                document.getElementById('squadCapacity').value = '';
                document.getElementById('squadIsQualifying').checked = false;

                renderSquadsList();
            }

            function editSquad(index) {
                const squad = currentSquads[index];
                document.getElementById('squadName').value = squad.name;
                document.getElementById('squadDate').value = squad.date;
                document.getElementById('squadTime').value = squad.time;
                document.getElementById('squadCapacity').value = squad.capacity;
                document.getElementById('squadIsQualifying').checked = squad.isQualifying;
                
                editingSquadIndex = index;
                document.querySelector('#squadsList ~ div button[onclick="addSquad()"]').textContent = 'Update Squad';
                
                // Scroll to squad form
                document.getElementById('squadName').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            function removeSquad(index) {
                if (editingSquadIndex === index) {
                    editingSquadIndex = null;
                    document.querySelector('#squadsList ~ div button[onclick="addSquad()"]').textContent = 'Add Squad';
                    // Clear inputs
                    document.getElementById('squadName').value = '';
                    document.getElementById('squadDate').value = '';
                    document.getElementById('squadTime').value = '';
                    document.getElementById('squadCapacity').value = '';
                    document.getElementById('squadIsQualifying').checked = false;
                }
                currentSquads.splice(index, 1);
                renderSquadsList();
            }

            function renderSquadsList() {
                const container = document.getElementById('squadsList');
                if (currentSquads.length === 0) {
                    container.innerHTML = '<p style="color:#b9c6d8;font-size:.85rem;margin:0">No squads added yet</p>';
                    return;
                }

                container.innerHTML = currentSquads.map((squad, index) => {
                    const squadDate = new Date(squad.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    return `
                        <div style="background:#141a22;padding:10px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,.05)">
                            <div>
                                <strong style="font-size:.9rem">${squad.name}</strong>
                                <span style="color:#b9c6d8;font-size:.85rem;margin-left:8px">
                                    ${squadDate} @ ${squad.time} ‚Ä¢ Capacity: ${squad.capacity}
                                    ${squad.isQualifying ? ' ‚Ä¢ <span style="color:#51cf66">Qualifying</span>' : ''}
                                </span>
                            </div>
                            <div style="display:flex;gap:6px">
                                <button type="button" class="button" onclick="editSquad(${index})" style="font-size:.75rem;padding:4px 8px;background:#6c757d">Edit</button>
                                <button type="button" class="btn-delete" onclick="removeSquad(${index})" style="font-size:.75rem;padding:4px 8px">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function editTournament(id) {
                fetch(`/api/tournaments/${id}`)
                    .then(res => res.json())
                    .then(tournament => {
                        document.getElementById('editingTournamentId').value = id;
                        document.getElementById('formTitle').textContent = 'Edit Tournament';
                        document.getElementById('submitBtn').textContent = 'Update Tournament';
                        document.getElementById('cancelBtn').style.display = 'inline-block';

                        // Fill form
                        form.name.value = tournament.name;
                        form.date.value = tournament.date.split('T')[0];
                        form.location.value = tournament.location;
                        form.status.value = tournament.status;
                        form.description.value = tournament.description || '';
                        form.maxParticipants.value = tournament.maxParticipants || '';
                        form.registrationDeadline.value = tournament.registrationDeadline ? tournament.registrationDeadline.split('T')[0] : '';
                        form.squadsRequiredToQualify.value = tournament.squadsRequiredToQualify || 1;

                        // Load squads
                        currentSquads = tournament.squads || [];
                        renderSquadsList();

                        // Scroll to form
                        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    })
                    .catch(error => {
                        alert('Failed to load tournament: ' + error.message);
                    });
            }

            function cancelEdit() {
                document.getElementById('editingTournamentId').value = '';
                document.getElementById('formTitle').textContent = 'Add New Tournament';
                document.getElementById('submitBtn').textContent = 'Add Tournament';
                document.getElementById('cancelBtn').style.display = 'none';
                form.reset();
                currentSquads = [];
                renderSquadsList();
            }

            // Load and display tournaments
            async function loadTournaments() {
                try {
                    const response = await fetch('/api/tournaments');
                    const tournaments = await response.json();

                    // Update registration filter dropdown
                    regFilterSelect.innerHTML = '<option value="">All Tournaments</option>' + 
                        tournaments.map(t => `<option value="${t._id}">${t.name} (${new Date(t.date).toLocaleDateString()})</option>`).join('');

                    if (tournaments.length === 0) {
                        listContainer.innerHTML = '<p style="color:#b9c6d8;text-align:center">No tournaments scheduled yet.</p>';
                        return;
                    }

                    listContainer.innerHTML = tournaments.map(t => {
                        const date = new Date(t.date).toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'long', day: 'numeric' 
                        });
                        const statusClass = `status-${t.status}`;
                        const squadCount = t.squads ? t.squads.length : 0;
                        
                        return `
                            <div class="tournament-item">
                                <div class="tournament-info">
                                    <h4>${t.name}</h4>
                                    <p>${date} ‚Ä¢ ${t.location} ‚Ä¢ <span class="status-badge ${statusClass}">${t.status}</span></p>
                                    ${t.description ? `<p style="margin-top:4px">${t.description}</p>` : ''}
                                    ${squadCount > 0 ? `<p style="margin-top:4px;font-size:.85rem;color:#b9c6d8">üìÖ ${squadCount} squad${squadCount !== 1 ? 's' : ''} configured</p>` : ''}
                                </div>
                                <div class="tournament-actions">
                                    <button class="button" onclick="editTournament('${t._id}')" style="font-size:.85rem;padding:6px 10px;background:#6c757d">Edit</button>
                                    <button class="btn-delete" onclick="deleteTournament('${t._id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    listContainer.innerHTML = '<p style="color:#c92a2a;text-align:center">Failed to load tournaments</p>';
                }
            }

            // Delete tournament
            async function deleteTournament(id) {
                if (!confirm('Are you sure you want to delete this tournament?')) return;

                try {
                    const response = await fetch(`/api/tournaments/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        loadTournaments();
                        loadRegistrations();
                    } else {
                        alert('Failed to delete tournament');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            // Load registrations
            async function loadRegistrations() {
                try {
                    const tournamentId = regFilterSelect.value;
                    const url = tournamentId 
                        ? `/api/registrations?tournamentId=${tournamentId}`
                        : '/api/registrations';
                    
                    const response = await fetch(url);
                    const registrations = await response.json();

                    regCountSpan.textContent = registrations.length;

                    if (registrations.length === 0) {
                        regListContainer.innerHTML = '<p style="color:#b9c6d8;text-align:center;padding:20px">No registrations found.</p>';
                        return;
                    }

                    // Fetch all tournaments to get squad names
                    const tournamentsRes = await fetch('/api/tournaments');
                    const allTournaments = await tournamentsRes.json();
                    const tournamentsById = {};
                    allTournaments.forEach(t => tournamentsById[t._id] = t);

                    regListContainer.innerHTML = `
                        <table style="width:100%;border-collapse:collapse">
                            <thead>
                                <tr style="border-bottom:1px solid rgba(255,255,255,.08);text-align:left">
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Player</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Tournament</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Squads</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Contact</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Status</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Registered</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${registrations.map(r => {
                                    // Get squad names for this registration
                                    let squadInfo = '<span style="color:#888;font-size:.85rem">None</span>';
                                    if (r.assignedSquads && r.assignedSquads.length > 0) {
                                        const tournament = tournamentsById[r.tournament._id];
                                        if (tournament && tournament.squads) {
                                            const squadNames = r.assignedSquads.map(squadId => {
                                                const squad = tournament.squads.find(s => s._id === squadId);
                                                return squad ? squad.name : 'Unknown';
                                            });
                                            squadInfo = squadNames.join('<br>');
                                        }
                                    }

                                    return `
                                    <tr style="border-bottom:1px solid rgba(255,255,255,.03)">
                                        <td style="padding:10px 8px">
                                            <strong>${r.playerName}</strong>
                                            ${r.averageScore ? `<br><span style="font-size:.8rem;color:#b9c6d8">Avg: ${r.averageScore}</span>` : ''}
                                        </td>
                                        <td style="padding:10px 8px;font-size:.9rem">${r.tournament?.name || 'N/A'}</td>
                                        <td style="padding:10px 8px;font-size:.85rem">${squadInfo}</td>
                                        <td style="padding:10px 8px;font-size:.85rem">
                                            ${r.email}<br>
                                            ${r.phone}
                                        </td>
                                        <td style="padding:10px 8px">
                                            <select onchange="updateRegistrationStatus('${r._id}', this.value)" style="font-size:.8rem;padding:4px 6px">
                                                <option value="pending" ${r.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="confirmed" ${r.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                                <option value="cancelled" ${r.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                <option value="waitlist" ${r.status === 'waitlist' ? 'selected' : ''}>Waitlist</option>
                                            </select>
                                        </td>
                                        <td style="padding:10px 8px;font-size:.85rem">${new Date(r.registeredAt).toLocaleDateString()}</td>
                                        <td style="padding:10px 8px">
                                            <button class="btn-delete" style="font-size:.75rem;padding:4px 8px" onclick="deleteRegistration('${r._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    `;
                } catch (error) {
                    regListContainer.innerHTML = '<p style="color:#c92a2a;text-align:center;padding:20px">Failed to load registrations</p>';
                }
            }

            // Update registration status
            async function updateRegistrationStatus(id, status) {
                try {
                    const response = await fetch(`/api/registrations/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    if (!response.ok) {
                        alert('Failed to update status');
                        loadRegistrations(); // Reload to reset dropdown
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                    loadRegistrations();
                }
            }

            // Delete registration
            async function deleteRegistration(id) {
                if (!confirm('Are you sure you want to delete this registration?')) return;

                try {
                    const response = await fetch(`/api/registrations/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        loadRegistrations();
                    } else {
                        alert('Failed to delete registration');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            // Export registrations to CSV
            async function exportRegistrations() {
                try {
                    const tournamentId = regFilterSelect.value;
                    const url = tournamentId 
                        ? `/api/registrations?tournamentId=${tournamentId}`
                        : '/api/registrations';
                    
                    const response = await fetch(url);
                    const registrations = await response.json();

                    if (registrations.length === 0) {
                        alert('No registrations to export');
                        return;
                    }

                    // Fetch all tournaments to get squad names
                    const tournamentsRes = await fetch('/api/tournaments');
                    const allTournaments = await tournamentsRes.json();
                    const tournamentsById = {};
                    allTournaments.forEach(t => tournamentsById[t._id] = t);

                    // Create CSV content
                    const headers = ['Player Name', 'Email', 'Phone', 'Tournament', 'Squads', 'Average Score', 'Status', 'Notes', 'Registered Date'];
                    const rows = registrations.map(r => {
                        // Get squad names
                        let squadNames = '';
                        if (r.assignedSquads && r.assignedSquads.length > 0) {
                            const tournament = tournamentsById[r.tournament._id];
                            if (tournament && tournament.squads) {
                                squadNames = r.assignedSquads.map(squadId => {
                                    const squad = tournament.squads.find(s => s._id === squadId);
                                    return squad ? squad.name : 'Unknown';
                                }).join('; ');
                            }
                        }

                        return [
                            r.playerName,
                            r.email,
                            r.phone,
                            r.tournament?.name || '',
                            squadNames,
                            r.averageScore || '',
                            r.status,
                            r.notes || '',
                            new Date(r.registeredAt).toLocaleDateString()
                        ];
                    });

                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                        .join('\n');

                    // Download CSV
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url2 = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url2;
                    a.download = `registrations-${tournamentId ? regFilterSelect.options[regFilterSelect.selectedIndex].text.replace(/[^a-z0-9]/gi, '_') : 'all'}-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url2);
                } catch (error) {
                    alert('Failed to export: ' + error.message);
                }
            }

            // Listen for filter changes
            regFilterSelect.addEventListener('change', loadRegistrations);
        </script>
    </body>
</html>
