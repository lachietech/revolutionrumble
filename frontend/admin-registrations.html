<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Registration Management ‚Äî Admin ‚Äî Revolution Rumble</title>
        <style>
            body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#070709;color:#e9eef7;margin:0}
            header{padding:14px 20px;background:#0f1520}
            .container{width:min(1100px,94%);margin:20px auto}
            .card{background:#0b0f14;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.03);margin-bottom:20px}
            .row{display:flex;gap:12px;align-items:center}
            .danger{background:#4a1919;color:#ffd8d8}
            a.button{display:inline-block;padding:8px 12px;background:#2e8fdc;color:white;border-radius:8px;text-decoration:none;border:none;cursor:pointer}
            button.button{display:inline-block;padding:8px 12px;background:#2e8fdc;color:white;border-radius:8px;text-decoration:none;border:none;cursor:pointer;font:inherit}
            button.button:hover,a.button:hover{background:#3a9fec}
            .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
            .form-group{display:flex;flex-direction:column;gap:4px}
            .form-group.full{grid-column:1/-1}
            label{font-size:.9rem;color:#b9c6d8}
            input,select,textarea{background:#141a22;border:1px solid rgba(255,255,255,.08);color:#e9eef7;padding:8px 10px;border-radius:6px;font:inherit}
            input:focus,select:focus,textarea:focus{outline:none;border-color:#2e8fdc}
            .tournament-list{display:grid;gap:10px;margin-top:12px}
            .tournament-item{background:#141a22;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.05);display:flex;justify-content:space-between;align-items:center}
            .tournament-info h4{margin:0 0 4px 0;font-size:1rem}
            .tournament-info p{margin:0;font-size:.85rem;color:#b9c6d8}
            .tournament-actions{display:flex;gap:8px}
            .btn-delete{background:#c92a2a;padding:6px 10px;border:none;color:white;border-radius:6px;cursor:pointer;font-size:.85rem}
            .btn-delete:hover{background:#e03131}
            .status-badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:.75rem;font-weight:600;text-transform:uppercase}
            .status-upcoming{background:rgba(46,143,220,.2);color:#5eb6f5}
            .status-ongoing{background:rgba(46,204,113,.2);color:#51cf66}
            .status-completed{background:rgba(134,142,150,.2);color:#adb5bd}
            @media(max-width:768px){.form-grid{grid-template-columns:1fr}}
        </style>
    </head>
    <body>
        <header>
            <div class="container row">
                <h1 style="margin:0;font-size:1.1rem">Registration Management</h1>
                <div style="margin-left:auto"><a class="button" href="/admin/logout">Sign out</a></div>
            </div>
        </header>

        <nav style="background:#141a22;border-bottom:1px solid rgba(255,255,255,.08);padding:12px 0">
            <div class="container" style="display:flex;gap:16px;align-items:center">
                <a href="/admin/tournaments" style="padding:8px 16px;border-radius:6px;text-decoration:none;color:#b9c6d8;transition:all .2s" onmouseover="this.style.background='rgba(59,130,246,.1)'" onmouseout="this.style.background=''">üèÜ Tournaments</a>
                <a href="/admin/registrations" style="padding:8px 16px;border-radius:6px;text-decoration:none;color:white;background:#3b82f6">üìã Registrations</a>
                <a href="/admin/results" style="padding:8px 16px;border-radius:6px;text-decoration:none;color:#b9c6d8;transition:all .2s" onmouseover="this.style.background='rgba(59,130,246,.1)'" onmouseout="this.style.background=''">üéØ Scores</a>
                <div style="margin-left:auto"><a href="/" style="text-decoration:none;color:#b9c6d8">‚Üê Back to Site</a></div>
            </div>
        </nav>

        <main class="container" style="margin-top:20px">

            <!-- Registration Management -->
            <div class="card">
                <h2 style="margin-top:0">üìã Registration Management</h2>
                
                <div class="form-group" style="margin-bottom:16px">
                    <label for="regTournamentFilter">Filter by Tournament</label>
                    <select id="regTournamentFilter" style="max-width:400px">
                        <option value="">All Tournaments</option>
                    </select>
                </div>

                <div style="margin-top:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
                    <h3 style="margin:0">Registrations (<span id="regCount">0</span>)</h3>
                    <div style="display:flex;gap:8px">
                        <button class="button" style="font-size:.85rem;padding:6px 12px" onclick="loadRegistrations()">Refresh</button>
                        <button class="button" style="font-size:.85rem;padding:6px 12px" onclick="exportRegistrations()">Export CSV</button>
                    </div>
                </div>

                <div id="registrationList" style="max-height:500px;overflow-y:auto">
                    <p style="color:#b9c6d8;text-align:center">Loading registrations...</p>
                </div>
            </div>
        </main>

        <script>
            const regListContainer = document.getElementById('registrationList');
            const regFilterSelect = document.getElementById('regTournamentFilter');
            const regCountSpan = document.getElementById('regCount');

            // Load tournaments and registrations on page load
            async function loadTournamentsForFilter() {
                try {
                    const response = await fetch('/api/tournaments');
                    const tournaments = await response.json();
                    regFilterSelect.innerHTML = '<option value="">All Tournaments</option>' + 
                        tournaments.map(t => {
                            const date = new Date(t.startDate || t.date).toLocaleDateString();
                            return `<option value="${t._id}">${t.name} (${date})</option>`;
                        }).join('');
                } catch (error) {
                    console.error('Error loading tournaments:', error);
                }
            }

            loadTournamentsForFilter();
            loadRegistrations();
            
            regFilterSelect.addEventListener('change', loadRegistrations);

            // Handle form submission (note: no form on this page, but keeping for compatibility)
            /*
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const editingId = document.getElementById('editingTournamentId').value;
                const isEditing = !!editingId;
                
                const formData = {
                    name: form.name.value,
                    date: form.date.value,
                    location: form.location.value,
                    status: form.status.value,
                    description: form.description.value,
                    maxParticipants: form.maxParticipants.value ? Number(form.maxParticipants.value) : null,
                    registrationDeadline: form.registrationDeadline.value || null,
                    squadsRequiredToQualify: form.squadsRequiredToQualify.value ? Number(form.squadsRequiredToQualify.value) : 1,
                    squads: currentSquads.map(s => {
                        const squad = {
                            name: s.name,
                            date: s.date,
                            time: s.time,
                            capacity: s.capacity,
                            isQualifying: s.isQualifying
                        };
                        // Only include _id if it's a valid MongoDB ObjectId (24 hex characters)
                        if (s._id && s._id.length === 24 && /^[0-9a-fA-F]{24}$/.test(s._id)) {
                            squad._id = s._id;
                        }
                        return squad;
                    }),
                    format: {
                        // If multi-stage, gamesPerBowler is sum of all stage games, otherwise use the input field
                        gamesPerBowler: document.getElementById('hasStages').checked 
                            ? currentStages.reduce((sum, stage) => sum + stage.games, 0)
                            : Number(document.getElementById('gamesPerBowler').value) || 6,
                        hasStages: document.getElementById('hasStages').checked,
                        stages: currentStages,
                        useHandicap: document.getElementById('useHandicap').checked,
                        handicapBase: Number(document.getElementById('handicapBase').value) || 200,
                        handicapPercentage: Number(document.getElementById('handicapPercentage').value) || 90,
                        bonusPoints: {
                            enabled: document.getElementById('bonusPointsEnabled').checked,
                            perGame: Number(document.getElementById('bonusPerGame').value) || 0,
                            perSeries: Number(document.getElementById('bonusPerSeries').value) || 0
                        },
                        scoringMethod: document.getElementById('scoringMethod').value,
                        matchPlay: {
                            pointsForWin: Number(document.getElementById('pointsForWin').value) || 30,
                            pointsForTie: Number(document.getElementById('pointsForTie').value) || 15,
                            pointsForLoss: Number(document.getElementById('pointsForLoss').value) || 0,
                            includePinfall: document.getElementById('includePinfall').checked
                        }
                    }
                };

                try {
                    const url = isEditing ? `/api/tournaments/${editingId}` : '/api/tournaments';
                    const method = isEditing ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        form.reset();
                        currentSquads = [];
                        renderSquadsList();
                        cancelEdit();
                        loadTournaments();
                        loadRegistrations();
                        alert(isEditing ? 'Tournament updated successfully!' : 'Tournament added successfully!');
                    } else {
                        const error = await response.json();
                        alert('Error: ' + error.error);
                    }
                } catch (error) {
                    alert('Failed to save tournament: ' + error.message);
                }
            });
            */

            // Squad management functions (commented out - not used on this page)
            /*
            let editingSquadIndex = null;

            function addSquad() {
                const name = document.getElementById('squadName').value;
                const date = document.getElementById('squadDate').value;
                const time = document.getElementById('squadTime').value;
                const capacity = document.getElementById('squadCapacity').value;
                const isQualifying = document.getElementById('squadIsQualifying').checked;

                if (!name || !date || !time || !capacity) {
                    alert('Please fill in all squad fields');
                    return;
                }

                const squadData = {
                    name,
                    date,
                    time,
                    capacity: Number(capacity),
                    isQualifying
                };

                if (editingSquadIndex !== null) {
                    // Update existing squad
                    currentSquads[editingSquadIndex] = {
                        ...currentSquads[editingSquadIndex],
                        ...squadData
                    };
                    editingSquadIndex = null;
                    document.querySelector('#squadsList ~ div button[onclick="addSquad()"]').textContent = 'Add Squad';
                } else {
                    // Add new squad
                    squadData._id = Date.now().toString(); // Temporary ID for new squads
                    currentSquads.push(squadData);
                }

                // Clear inputs
                document.getElementById('squadName').value = '';
                document.getElementById('squadDate').value = '';
                document.getElementById('squadTime').value = '';
                document.getElementById('squadCapacity').value = '';
                document.getElementById('squadIsQualifying').checked = false;

                renderSquadsList();
            }
            
            function addStage() {
                const name = document.getElementById('stageName').value;
                const games = document.getElementById('stageGames').value;
                const advancing = document.getElementById('stageAdvancing').value;
                const carryover = document.getElementById('stageCarryover').checked;
                const carryoverPct = document.getElementById('stageCarryoverPct').value;

                if (!name || !games) {
                    alert('Please fill in stage name and games');
                    return;
                }

                currentStages.push({
                    name,
                    games: Number(games),
                    advancingBowlers: advancing ? Number(advancing) : null,
                    carryoverPinfall: carryover,
                    carryoverPercentage: Number(carryoverPct) || 100
                });

                // Clear inputs
                document.getElementById('stageName').value = '';
                document.getElementById('stageGames').value = '6';
                document.getElementById('stageAdvancing').value = '';
                document.getElementById('stageCarryover').checked = true;
                document.getElementById('stageCarryoverPct').value = '100';

                renderStagesList();
            }
            
            function removeStage(index) {
                currentStages.splice(index, 1);
                renderStagesList();
            }
            
            function renderStagesList() {
                const container = document.getElementById('stagesList');
                if (currentStages.length === 0) {
                    container.innerHTML = '<p style="color:#888;text-align:center;padding:8px;font-size:.85rem">No stages added yet</p>';
                    return;
                }
                
                container.innerHTML = currentStages.map((stage, i) => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.05);border-radius:6px">
                        <div>
                            <strong>${stage.name}</strong> ‚Ä¢ ${stage.games} games
                            ${stage.advancingBowlers ? ` ‚Ä¢ Top ${stage.advancingBowlers} advance` : ''}
                            ${stage.carryoverPinfall ? ` ‚Ä¢ ${stage.carryoverPercentage}% carryover` : ''}
                        </div>
                        <button onclick="removeStage(${i})" class="button" style="padding:4px 8px;font-size:.75rem;background:#c92a2a">Remove</button>
                    </div>
                `).join('');
            }

            function editSquad(index) {
                const squad = currentSquads[index];
                document.getElementById('squadName').value = squad.name;
                document.getElementById('squadDate').value = squad.date;
                document.getElementById('squadTime').value = squad.time;
                document.getElementById('squadCapacity').value = squad.capacity;
                document.getElementById('squadIsQualifying').checked = squad.isQualifying;
                
                editingSquadIndex = index;
                document.querySelector('#squadsList ~ div button[onclick="addSquad()"]').textContent = 'Update Squad';
                
                // Scroll to squad form
                document.getElementById('squadName').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            function removeSquad(index) {
                if (editingSquadIndex === index) {
                    editingSquadIndex = null;
                    document.querySelector('#squadsList ~ div button[onclick="addSquad()"]').textContent = 'Add Squad';
                    // Clear inputs
                    document.getElementById('squadName').value = '';
                    document.getElementById('squadDate').value = '';
                    document.getElementById('squadTime').value = '';
                    document.getElementById('squadCapacity').value = '';
                    document.getElementById('squadIsQualifying').checked = false;
                }
                currentSquads.splice(index, 1);
                renderSquadsList();
            }

            function renderSquadsList() {
                const container = document.getElementById('squadsList');
                if (currentSquads.length === 0) {
                    container.innerHTML = '<p style="color:#b9c6d8;font-size:.85rem;margin:0">No squads added yet</p>';
                    return;
                }

                container.innerHTML = currentSquads.map((squad, index) => {
                    const squadDate = new Date(squad.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    return `
                        <div style="background:#141a22;padding:10px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,.05)">
                            <div>
                                <strong style="font-size:.9rem">${squad.name}</strong>
                                <span style="color:#b9c6d8;font-size:.85rem;margin-left:8px">
                                    ${squadDate} @ ${squad.time} ‚Ä¢ Capacity: ${squad.capacity}
                                    ${squad.isQualifying ? ' ‚Ä¢ <span style="color:#51cf66">Qualifying</span>' : ''}
                                </span>
                            </div>
                            <div style="display:flex;gap:6px">
                                <button type="button" class="button" onclick="editSquad(${index})" style="font-size:.75rem;padding:4px 8px;background:#6c757d">Edit</button>
                                <button type="button" class="btn-delete" onclick="removeSquad(${index})" style="font-size:.75rem;padding:4px 8px">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            */

            function editTournament(id) {
                // Redirect to tournaments page for editing
                window.location.href = `/admin/tournaments`;
            }

            function cancelEdit() {
                // No-op: This page doesn't have tournament editing
            }

            // Load and display tournaments
            async function loadTournaments() {
                try {
                    const response = await fetch('/api/tournaments');
                    const tournaments = await response.json();

                    // Update registration filter dropdown
                    regFilterSelect.innerHTML = '<option value="">All Tournaments</option>' + 
                        tournaments.map(t => `<option value="${t._id}">${t.name} (${new Date(t.date).toLocaleDateString()})</option>`).join('');

                    // Update results tournament filter dropdown
                    resultsTournamentFilter.innerHTML = '<option value="">Choose a tournament...</option>' + 
                        tournaments.map(t => `<option value="${t._id}">${t.name} (${new Date(t.date).toLocaleDateString()})</option>`).join('');

                    if (tournaments.length === 0) {
                        listContainer.innerHTML = '<p style="color:#b9c6d8;text-align:center">No tournaments scheduled yet.</p>';
                        return;
                    }

                    listContainer.innerHTML = tournaments.map(t => {
                        const date = new Date(t.date).toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'long', day: 'numeric' 
                        });
                        const statusClass = `status-${t.status}`;
                        const squadCount = t.squads ? t.squads.length : 0;
                        
                        // Format info
                        const format = t.format || {};
                        const formatDetails = [];
                        if (format.gamesPerBowler && format.gamesPerBowler !== 3) {
                            formatDetails.push(`${format.gamesPerBowler} games`);
                        }
                        if (format.scoringMethod && format.scoringMethod !== 'total-pinfall') {
                            const methodNames = { 'match-play': 'Match Play', 'head-to-head': 'H2H', 'points': 'Points' };
                            formatDetails.push(methodNames[format.scoringMethod] || format.scoringMethod);
                        }
                        if (format.useHandicap) formatDetails.push('Handicap');
                        if (format.hasStages) formatDetails.push(`${format.stages?.length || 0} stages`);
                        if (format.bonusPoints?.enabled) formatDetails.push('Bonus Points');
                        
                        const formatInfo = formatDetails.length > 0 
                            ? `<p style="margin-top:4px;font-size:.85rem;color:#6c9bd1">‚öôÔ∏è ${formatDetails.join(' ‚Ä¢ ')}</p>` 
                            : '';
                        
                        return `
                            <div class="tournament-item">
                                <div class="tournament-info">
                                    <h4>${t.name}</h4>
                                    <p>${date} ‚Ä¢ ${t.location} ‚Ä¢ <span class="status-badge ${statusClass}">${t.status}</span></p>
                                    ${t.description ? `<p style="margin-top:4px">${t.description}</p>` : ''}
                                    ${squadCount > 0 ? `<p style="margin-top:4px;font-size:.85rem;color:#b9c6d8">üìÖ ${squadCount} squad${squadCount !== 1 ? 's' : ''} configured</p>` : ''}
                                    ${formatInfo}
                                </div>
                                <div class="tournament-actions">
                                    <button class="button" onclick="editTournament('${t._id}')" style="font-size:.85rem;padding:6px 10px;background:#6c757d">Edit</button>
                                    <button class="btn-delete" onclick="deleteTournament('${t._id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    listContainer.innerHTML = '<p style="color:#c92a2a;text-align:center">Failed to load tournaments</p>';
                }
            }

            // Delete tournament
            async function deleteTournament(id) {
                if (!confirm('Are you sure you want to delete this tournament?')) return;

                try {
                    const response = await fetch(`/api/tournaments/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        loadTournaments();
                        loadRegistrations();
                    } else {
                        alert('Failed to delete tournament');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            // Load registrations
            async function loadRegistrations() {
                try {
                    const tournamentId = regFilterSelect.value;
                    const url = tournamentId 
                        ? `/api/registrations?tournamentId=${tournamentId}`
                        : '/api/registrations';
                    
                    const response = await fetch(url);
                    const registrations = await response.json();

                    regCountSpan.textContent = registrations.length;

                    if (registrations.length === 0) {
                        regListContainer.innerHTML = '<p style="color:#b9c6d8;text-align:center;padding:20px">No registrations found.</p>';
                        return;
                    }

                    // Fetch all tournaments to get squad names
                    const tournamentsRes = await fetch('/api/tournaments');
                    const allTournaments = await tournamentsRes.json();
                    const tournamentsById = {};
                    allTournaments.forEach(t => tournamentsById[t._id] = t);

                    regListContainer.innerHTML = `
                        <table style="width:100%;border-collapse:collapse">
                            <thead>
                                <tr style="border-bottom:1px solid rgba(255,255,255,.08);text-align:left">
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Player</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Tournament</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Squads</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Contact</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Status</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Registered</th>
                                    <th style="padding:10px 8px;font-size:.85rem;color:#b9c6d8">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${registrations.map(r => {
                                    // Get squad names for this registration
                                    let squadInfo = '<span style="color:#888;font-size:.85rem">None</span>';
                                    if (r.assignedSquads && r.assignedSquads.length > 0) {
                                        const tournament = tournamentsById[r.tournament._id];
                                        if (tournament && tournament.squads) {
                                            const squadNames = r.assignedSquads.map(squadId => {
                                                const squad = tournament.squads.find(s => s._id === squadId);
                                                return squad ? squad.name : 'Unknown';
                                            });
                                            squadInfo = squadNames.join('<br>');
                                        }
                                    }

                                    return `
                                    <tr style="border-bottom:1px solid rgba(255,255,255,.03)">
                                        <td style="padding:10px 8px">
                                            <strong>${r.playerName}</strong>
                                            ${r.gender ? `<span style="font-size:.75rem;padding:2px 6px;background:${r.gender === 'female' ? 'rgba(236, 72, 153, .2)' : 'rgba(59, 130, 246, .2)'};color:${r.gender === 'female' ? '#ec4899' : '#3b82f6'};border-radius:4px;margin-left:6px">${r.gender === 'female' ? '‚ôÄ F' : '‚ôÇ M'}</span>` : ''}
                                            ${r.averageScore ? `<br><span style="font-size:.8rem;color:#b9c6d8">Avg: ${r.averageScore}</span>` : ''}
                                        </td>
                                        <td style="padding:10px 8px;font-size:.9rem">${r.tournament?.name || 'N/A'}</td>
                                        <td style="padding:10px 8px;font-size:.85rem">${squadInfo}</td>
                                        <td style="padding:10px 8px;font-size:.85rem">
                                            ${r.email}<br>
                                            ${r.phone}
                                        </td>
                                        <td style="padding:10px 8px">
                                            <select onchange="updateRegistrationStatus('${r._id}', this.value)" style="font-size:.8rem;padding:4px 6px">
                                                <option value="pending" ${r.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="confirmed" ${r.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                                <option value="cancelled" ${r.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                <option value="waitlist" ${r.status === 'waitlist' ? 'selected' : ''}>Waitlist</option>
                                            </select>
                                        </td>
                                        <td style="padding:10px 8px;font-size:.85rem">${new Date(r.registeredAt).toLocaleDateString()}</td>
                                        <td style="padding:10px 8px">
                                            <button class="btn-delete" style="font-size:.75rem;padding:4px 8px" onclick="deleteRegistration('${r._id}')">Delete</button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    `;
                } catch (error) {
                    regListContainer.innerHTML = '<p style="color:#c92a2a;text-align:center;padding:20px">Failed to load registrations</p>';
                }
            }

            // Update registration status
            async function updateRegistrationStatus(id, status) {
                try {
                    const response = await fetch(`/api/registrations/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    if (!response.ok) {
                        alert('Failed to update status');
                        loadRegistrations(); // Reload to reset dropdown
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                    loadRegistrations();
                }
            }

            // Delete registration
            async function deleteRegistration(id) {
                if (!confirm('Are you sure you want to delete this registration?')) return;

                try {
                    const response = await fetch(`/api/registrations/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        loadRegistrations();
                    } else {
                        alert('Failed to delete registration');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            // Export registrations to CSV
            async function exportRegistrations() {
                try {
                    const tournamentId = regFilterSelect.value;
                    const url = tournamentId 
                        ? `/api/registrations?tournamentId=${tournamentId}`
                        : '/api/registrations';
                    
                    const response = await fetch(url);
                    const registrations = await response.json();

                    if (registrations.length === 0) {
                        alert('No registrations to export');
                        return;
                    }

                    // Fetch all tournaments to get squad names
                    const tournamentsRes = await fetch('/api/tournaments');
                    const allTournaments = await tournamentsRes.json();
                    const tournamentsById = {};
                    allTournaments.forEach(t => tournamentsById[t._id] = t);

                    // Create CSV content
                    const headers = ['Player Name', 'Email', 'Phone', 'Tournament', 'Squads', 'Average Score', 'Status', 'Notes', 'Registered Date'];
                    const rows = registrations.map(r => {
                        // Get squad names
                        let squadNames = '';
                        if (r.assignedSquads && r.assignedSquads.length > 0) {
                            const tournament = tournamentsById[r.tournament._id];
                            if (tournament && tournament.squads) {
                                squadNames = r.assignedSquads.map(squadId => {
                                    const squad = tournament.squads.find(s => s._id === squadId);
                                    return squad ? squad.name : 'Unknown';
                                }).join('; ');
                            }
                        }

                        return [
                            r.playerName,
                            r.email,
                            r.phone,
                            r.tournament?.name || '',
                            squadNames,
                            r.averageScore || '',
                            r.status,
                            r.notes || '',
                            new Date(r.registeredAt).toLocaleDateString()
                        ];
                    });

                    const csvContent = [headers, ...rows]
                        .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                        .join('\n');

                    // Download CSV
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url2 = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url2;
                    a.download = `registrations-${tournamentId ? regFilterSelect.options[regFilterSelect.selectedIndex].text.replace(/[^a-z0-9]/gi, '_') : 'all'}-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url2);
                } catch (error) {
                    alert('Failed to export: ' + error.message);
                }
            }

            // Listen for filter changes
            regFilterSelect.addEventListener('change', loadRegistrations);

            // ==================== RESULTS MANAGEMENT ====================

            async function loadTournamentResults() {
                const tournamentId = resultsTournamentFilter.value;
                const container = document.getElementById('resultsContainer');

                if (!tournamentId) {
                    container.innerHTML = '<p style="color:#b9c6d8;text-align:center">Select a tournament to manage results</p>';
                    return;
                }

                try {
                    // Load tournament details
                    const tournamentsRes = await fetch('/api/tournaments');
                    const tournaments = await tournamentsRes.json();
                    currentTournamentForResults = tournaments.find(t => t._id === tournamentId);

                    // Load registrations
                    const regRes = await fetch(`/api/registrations?tournamentId=${tournamentId}`);
                    const registrations = await regRes.json();

                    if (registrations.length === 0) {
                        container.innerHTML = '<p style="color:#b9c6d8;text-align:center">No registrations for this tournament</p>';
                        return;
                    }

                    // Organize by squad if squads exist
                    if (currentTournamentForResults.squads && currentTournamentForResults.squads.length > 0) {
                        renderSquadResults(registrations);
                    } else {
                        renderSimpleResults(registrations);
                    }

                } catch (error) {
                    console.error('Error loading results:', error);
                    container.innerHTML = '<p style="color:#c92a2a;text-align:center">Failed to load tournament data</p>';
                }
            }

            function renderSquadResults(registrations) {
                const container = document.getElementById('resultsContainer');
                const squads = currentTournamentForResults.squads;
                const gamesCount = currentTournamentForResults?.format?.gamesPerBowler || 3;

                let html = '<div style="display:flex;flex-direction:column;gap:24px">';

                squads.forEach(squad => {
                    const squadRegistrations = registrations.filter(reg => 
                        reg.assignedSquads && reg.assignedSquads.some(sid => sid.toString() === squad._id.toString())
                    );

                    if (squadRegistrations.length === 0) return;
                    
                    // Generate game header columns
                    const gameHeaders = Array.from({length: gamesCount}, (_, i) => 
                        `<th style="padding:8px;text-align:center;font-size:.85rem;color:#b9c6d8">Game ${i+1}</th>`
                    ).join('');

                    html += `
                        <div style="border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:16px;background:rgba(255,255,255,.02)">
                            <h3 style="margin:0 0 16px;color:var(--blue-500)">${squad.name}</h3>
                            <table style="width:100%;border-collapse:collapse">
                                <thead>
                                    <tr style="border-bottom:1px solid rgba(255,255,255,.08)">
                                        <th style="padding:8px;text-align:left;font-size:.85rem;color:#b9c6d8">Bowler</th>
                                        ${gameHeaders}
                                        <th style="padding:8px;text-align:center;font-size:.85rem;color:#b9c6d8">Total</th>
                                        <th style="padding:8px;text-align:center;font-size:.85rem;color:#b9c6d8">Avg</th>
                                        <th style="padding:8px;text-align:center;font-size:.85rem;color:#b9c6d8">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="squad-${squad._id}-results">
                                    ${squadRegistrations.map(reg => renderResultRow(reg, squad._id)).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

                // Load existing results
                loadExistingResults();
            }

            function renderSimpleResults(registrations) {
                const container = document.getElementById('resultsContainer');
                const gamesCount = currentTournamentForResults?.format?.gamesPerBowler || 3;
                
                // Generate game header columns
                const gameHeaders = Array.from({length: gamesCount}, (_, i) => 
                    `<th style="padding:8px;text-align:center;font-size:.85rem;color:#b9c6d8">Game ${i+1}</th>`
                ).join('');

                container.innerHTML = `
                    <table style="width:100%;border-collapse:collapse">
                        <thead>
                            <tr style="border-bottom:1px solid rgba(255,255,255,.08)">
                                <th style="padding:8px;text-align:left;font-size:.85rem;color:#b9c6d8">Bowler</th>
                                ${gameHeaders}
                                <th style="padding:8px;text-align:center;font-size:.85rem;color:#b9c6d8">Total</th>
                                <th style="padding:8px;text-align:center;font-size:.85rem;color:#b9c6d8">Avg</th>
                                <th style="padding:8px;text-align:center;font-size:.85rem;color:#b9c6d8">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${registrations.map(reg => renderResultRow(reg, null)).join('')}
                        </tbody>
                    </table>
                `;

                loadExistingResults();
            }

            function renderResultRow(registration, squadId) {
                const rowId = squadId ? `result-${registration.bowler}-${squadId}` : `result-${registration.bowler}`;
                const gamesCount = currentTournamentForResults?.format?.gamesPerBowler || 3;
                
                console.log('Rendering row:', { rowId, gamesCount, registration });
                
                // Generate game input columns
                const gameInputs = Array.from({length: gamesCount}, (_, i) => `
                    <td style="padding:8px;text-align:center">
                        <input type="number" id="${rowId}-g${i+1}" min="0" max="300" style="width:60px;padding:4px;text-align:center" />
                    </td>
                `).join('');
                
                return `
                    <tr id="${rowId}" style="border-bottom:1px solid rgba(255,255,255,.03)">
                        <td style="padding:8px">
                            <strong>${registration.playerName}</strong>
                            ${registration.averageScore ? `<br><span style="font-size:.8rem;color:#b9c6d8">Avg: ${registration.averageScore}</span>` : ''}
                        </td>
                        ${gameInputs}
                        <td style="padding:8px;text-align:center;font-weight:700" id="${rowId}-total">-</td>
                        <td style="padding:8px;text-align:center;font-weight:700;color:var(--blue-500)" id="${rowId}-avg">-</td>
                        <td style="padding:8px;text-align:center">
                            <button class="button" style="font-size:.75rem;padding:4px 8px" 
                                onclick="saveResult('${registration.bowler}', '${squadId || ''}', '${rowId}')">
                                Save
                            </button>
                        </td>
                    </tr>
                `;
            }

            async function loadExistingResults() {
                if (!currentTournamentForResults) return;

                console.log('Loading existing results for tournament:', currentTournamentForResults._id);

                try {
                    // Load all registrations to get bowler IDs
                    const regRes = await fetch(`/api/tournaments/${currentTournamentForResults._id}/registrations`);
                    const registrations = await regRes.json();
                    
                    console.log('Loaded registrations:', registrations.length);
                    
                    // For each bowler, load their results
                    for (const reg of registrations) {
                        if (!reg.bowler) continue;
                        
                        const bowlerId = reg.bowler._id || reg.bowler;
                        
                        try {
                            const historyRes = await fetch(`/api/bowlers/${bowlerId}/history`);
                            if (!historyRes.ok) continue;
                            
                            const history = await historyRes.json();
                            
                            if (!history.results || history.results.length === 0) continue;
                            
                            // Find result matching current tournament
                            const result = history.results.find(r => {
                                if (!r || !r.tournament) return false;
                                const tournamentId = typeof r.tournament === 'object' ? r.tournament._id : r.tournament;
                                return tournamentId === currentTournamentForResults._id;
                            });
                            
                            if (result && result.squadResults && result.squadResults.length > 0) {
                                console.log('Found existing result for bowler:', bowlerId, result);
                                
                                result.squadResults.forEach(squadResult => {
                                    const squadId = squadResult.squadId || '';
                                    const rowId = squadId ? `result-${bowlerId}-${squadId}` : `result-${bowlerId}`;
                                    
                                    // Populate game scores
                                    if (squadResult.games && squadResult.games.length > 0) {
                                        squadResult.games.forEach((score, i) => {
                                            const input = document.getElementById(`${rowId}-g${i+1}`);
                                            if (input) {
                                                input.value = score;
                                                console.log(`Set ${rowId}-g${i+1} to ${score}`);
                                            }
                                        });
                                        
                                        // Calculate and display totals
                                        const games = squadResult.games.filter(g => g >= 0);
                                        if (games.length > 0) {
                                            const total = games.reduce((sum, g) => sum + g, 0);
                                            const avg = Math.round(total / games.length);
                                            const totalEl = document.getElementById(`${rowId}-total`);
                                            const avgEl = document.getElementById(`${rowId}-avg`);
                                            if (totalEl) totalEl.textContent = total;
                                            if (avgEl) avgEl.textContent = avg;
                                            
                                            // Mark row as saved
                                            const row = document.getElementById(rowId);
                                            if (row) row.style.background = 'rgba(46, 204, 113, .05)';
                                        }
                                    }
                                });
                            }
                        } catch (err) {
                            console.error(`Error loading results for bowler ${bowlerId}:`, err);
                        }
                    }
                } catch (error) {
                    console.error('Error loading existing results:', error);
                }
            }

            async function saveResult(bowlerId, squadId, rowId) {
                const gamesCount = currentTournamentForResults?.format?.gamesPerBowler || 3;
                const games = [];
                
                console.log('Saving result:', { bowlerId, squadId, rowId, gamesCount });
                
                // Collect all game scores (include empty fields as they may be filled later)
                for (let i = 1; i <= gamesCount; i++) {
                    const input = document.getElementById(`${rowId}-g${i}`);
                    const value = input?.value;
                    console.log(`Game ${i} input:`, input, 'value:', value);
                    
                    if (value !== '' && value !== null && value !== undefined) {
                        const score = parseInt(value);
                        if (!isNaN(score) && score >= 0) {
                            games.push(score);
                        }
                    }
                }

                console.log('Collected games:', games);

                if (games.length === 0) {
                    alert('Please enter at least one score');
                    return;
                }

                const total = games.reduce((sum, g) => sum + g, 0);
                const avg = Math.round(total / games.length);

                // Update display
                document.getElementById(`${rowId}-total`).textContent = total;
                document.getElementById(`${rowId}-avg`).textContent = avg;

                // Prepare data
                const squadResults = squadId && squadId !== '' ? [{
                    squadId: squadId,
                    squadName: currentTournamentForResults.squads?.find(s => s._id === squadId)?.name || '',
                    games: games
                }] : [{
                    games: games
                }];

                const payload = {
                    bowlerId: bowlerId,
                    tournamentId: currentTournamentForResults._id,
                    squadResults: squadResults
                };

                console.log('Sending payload:', payload);

                try {
                    const response = await fetch('/api/results', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server error:', errorText);
                        throw new Error(`Failed to save result: ${response.status} - ${errorText}`);
                    }

                    const savedResult = await response.json();
                    console.log('Saved successfully:', savedResult);

                    // Visual feedback
                    const row = document.getElementById(rowId);
                    row.style.background = 'rgba(46, 204, 113, .1)';
                    setTimeout(() => row.style.background = 'rgba(46, 204, 113, .05)', 2000);

                    // Show success message
                    const saveBtn = row.querySelector('button');
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '‚úì Saved';
                    saveBtn.style.background = '#2ecc71';
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                        saveBtn.style.background = '';
                    }, 2000);
                } catch (error) {
                    console.error('Error saving result:', error);
                    alert('Failed to save result: ' + error.message);
                }
            }

            // Auto-calculate totals and averages on input
            document.addEventListener('input', (e) => {
                if (e.target.type === 'number' && e.target.id.includes('result-')) {
                    const rowId = e.target.id.split('-g')[0];
                    const gamesCount = currentTournamentForResults?.format?.gamesPerBowler || 3;
                    
                    // Collect all game scores dynamically
                    const games = [];
                    for (let i = 1; i <= gamesCount; i++) {
                        const score = parseInt(document.getElementById(`${rowId}-g${i}`)?.value) || 0;
                        if (score > 0) games.push(score);
                    }
                    
                    // Calculate and display totals
                    if (games.length > 0) {
                        const total = games.reduce((sum, g) => sum + g, 0);
                        const avg = Math.round(total / games.length);
                        document.getElementById(`${rowId}-total`).textContent = total;
                        document.getElementById(`${rowId}-avg`).textContent = avg;
                    } else {
                        document.getElementById(`${rowId}-total`).textContent = '-';
                        document.getElementById(`${rowId}-avg`).textContent = '-';
                    }
                }
            });
        </script>
    </body>
</html>
