<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Results | Revolution Rumble</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .results-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        .results-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .results-header h1 {
            color: var(--blue-500);
            margin-bottom: 8px;
        }

        .tournament-selector {
            max-width: 400px;
            margin: 24px auto;
        }

        .tournament-selector select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 8px;
            background: rgba(255, 255, 255, .03);
            color: white;
            font-size: 1rem;
        }

        .tournament-info-card {
            background: rgba(255, 255, 255, .03);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .tournament-info-card h2 {
            color: var(--blue-500);
            margin-bottom: 12px;
        }

        .tournament-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            color: #b9c6d8;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: .85rem;
            opacity: .7;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }

        .squad-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            justify-content: center;
        }

        .squad-filter-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 6px;
            background: rgba(255, 255, 255, .03);
            color: white;
            cursor: pointer;
            transition: all .2s;
        }

        .squad-filter-btn:hover {
            background: rgba(255, 255, 255, .08);
        }

        .squad-filter-btn.active {
            background: var(--blue-500);
            border-color: var(--blue-500);
        }

        .results-table {
            background: rgba(255, 255, 255, .03);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 32px;
        }

        .results-table h3 {
            padding: 16px 24px;
            margin: 0;
            background: rgba(255, 255, 255, .05);
            border-bottom: 1px solid rgba(255, 255, 255, .08);
            color: var(--blue-500);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead tr {
            background: rgba(255, 255, 255, .02);
            border-bottom: 1px solid rgba(255, 255, 255, .08);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: .85rem;
            color: #b9c6d8;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        th.center {
            text-align: center;
        }

        tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, .03);
            transition: background .15s;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, .04);
        }

        tbody tr.podium-1 {
            background: rgba(255, 215, 0, .08);
        }

        tbody tr.podium-2 {
            background: rgba(192, 192, 192, .08);
        }

        tbody tr.podium-3 {
            background: rgba(205, 127, 50, .08);
        }

        td {
            padding: 16px;
            color: white;
        }

        td.center {
            text-align: center;
        }

        .rank-cell {
            font-weight: 700;
            font-size: 1.2rem;
            width: 60px;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .bowler-name {
            font-weight: 600;
        }

        .bowler-name a {
            color: white;
            text-decoration: none;
            transition: color .2s;
        }

        .bowler-name a:hover {
            color: var(--blue-500);
        }

        .games-cell {
            font-size: .9rem;
            color: #b9c6d8;
        }

        .avg-cell {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--blue-500);
        }

        .total-cell {
            font-weight: 700;
        }

        .no-results {
            text-align: center;
            padding: 48px 16px;
            color: #b9c6d8;
        }

        .no-results-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: .3;
        }

        @media (max-width: 768px) {
            .tournament-details {
                grid-template-columns: 1fr;
            }

            table {
                font-size: .85rem;
            }

            th, td {
                padding: 8px;
            }

            .games-cell {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <a href="/" class="nav-brand">Revolution Rumble</a>
            <div class="nav-links">
                <a href="/events">Events</a>
                <a href="/squads">Squads</a>
                <a href="/tournamentresults" class="nav-active">Results</a>
                <a href="/playerstats">Bowlers</a>
                <a href="/register">Register</a>
            </div>
        </div>
    </div>

    <main class="results-page">
        <div class="results-header">
            <h1>üèÜ Tournament Results</h1>
            <p style="color:#b9c6d8">View leaderboards and standings from past tournaments</p>
        </div>

        <div class="tournament-selector">
            <select id="tournamentFilter" onchange="loadResults()">
                <option value="">Select a tournament...</option>
            </select>
        </div>

        <div id="resultsContainer">
            <div class="no-results">
                <div class="no-results-icon">üé≥</div>
                <p>Select a tournament to view results</p>
            </div>
        </div>
    </main>

    <script>
        let currentTournament = null;
        let allResults = [];
        let currentSquadFilter = 'all';

        async function init() {
            await loadTournaments();
            
            // Check URL parameter for tournament ID
            const urlParams = new URLSearchParams(window.location.search);
            const tournamentId = urlParams.get('id');
            if (tournamentId) {
                document.getElementById('tournamentFilter').value = tournamentId;
                await loadResults();
            }
        }

        async function loadTournaments() {
            try {
                const response = await fetch('/api/tournaments');
                const tournaments = await response.json();

                // Sort by date descending
                tournaments.sort((a, b) => new Date(b.date) - new Date(a.date));

                const select = document.getElementById('tournamentFilter');
                select.innerHTML = '<option value="">Select a tournament...</option>';
                
                tournaments.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t._id;
                    opt.textContent = `${t.name} - ${new Date(t.date).toLocaleDateString()}`;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error('Error loading tournaments:', error);
            }
        }

        async function loadResults() {
            const tournamentId = document.getElementById('tournamentFilter').value;
            const container = document.getElementById('resultsContainer');

            if (!tournamentId) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üé≥</div>
                        <p>Select a tournament to view results</p>
                    </div>
                `;
                return;
            }

            try {
                // Load tournament details
                const tournamentRes = await fetch(`/api/tournaments/${tournamentId}`);
                currentTournament = await tournamentRes.json();

                // Load all registrations
                const regRes = await fetch(`/api/registrations?tournamentId=${tournamentId}`);
                const registrations = await regRes.json();

                // Create a map of bowlerId to registration data
                const bowlerMap = {};
                registrations.forEach(reg => {
                    if (reg.bowler) {
                        bowlerMap[reg.bowler._id || reg.bowler] = {
                            name: reg.playerName,
                            email: reg.email,
                            bowlerId: reg.bowler._id || reg.bowler,
                            assignedSquads: reg.assignedSquads || []
                        };
                    }
                });

                // Fetch results for each bowler (simplified - ideally would have a dedicated endpoint)
                allResults = [];
                for (const bowlerId in bowlerMap) {
                    try {
                        const historyRes = await fetch(`/api/bowlers/${bowlerId}/history`);
                        const history = await historyRes.json();
                        
                        // Find result for this tournament
                        const result = history.results?.find(r => 
                            (r.tournament._id || r.tournament) === tournamentId
                        );

                        if (result) {
                            allResults.push({
                                ...result,
                                bowlerName: bowlerMap[bowlerId].name,
                                bowlerId: bowlerId
                            });
                        }
                    } catch (err) {
                        console.error(`Error loading results for bowler ${bowlerId}:`, err);
                    }
                }

                // Update URL
                const url = new URL(window.location);
                url.searchParams.set('id', tournamentId);
                window.history.replaceState({}, '', url);

                renderResults();
            } catch (error) {
                console.error('Error loading results:', error);
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">‚ö†Ô∏è</div>
                        <p>Failed to load results</p>
                    </div>
                `;
            }
        }

        function renderResults() {
            const container = document.getElementById('resultsContainer');

            if (allResults.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üìä</div>
                        <p>No results have been posted yet for this tournament</p>
                    </div>
                `;
                return;
            }

            // Render tournament info
            let html = `
                <div class="tournament-info-card">
                    <h2>${currentTournament.name}</h2>
                    <div class="tournament-details">
                        <div class="detail-item">
                            <span class="detail-label">Date</span>
                            <span class="detail-value">${new Date(currentTournament.date).toLocaleDateString('en-US', { 
                                year: 'numeric', month: 'long', day: 'numeric' 
                            })}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Location</span>
                            <span class="detail-value">${currentTournament.location}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Participants</span>
                            <span class="detail-value">${allResults.length}</span>
                        </div>
                        ${allResults[0]?.tournamentAverage ? `
                        <div class="detail-item">
                            <span class="detail-label">Tournament Average</span>
                            <span class="detail-value">${Math.round(allResults.reduce((sum, r) => sum + (r.tournamentAverage || 0), 0) / allResults.length)}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Squad filter if tournament has squads
            if (currentTournament.squads && currentTournament.squads.length > 0) {
                html += '<div class="squad-filter">';
                html += `<button class="squad-filter-btn ${currentSquadFilter === 'all' ? 'active' : ''}" onclick="filterBySquad('all')">All Squads</button>`;
                currentTournament.squads.forEach(squad => {
                    html += `<button class="squad-filter-btn ${currentSquadFilter === squad._id ? 'active' : ''}" onclick="filterBySquad('${squad._id}')">${squad.name}</button>`;
                });
                html += '</div>';
            }

            // Sort results by average (descending)
            const sortedResults = [...allResults].sort((a, b) => {
                const avgA = a.tournamentAverage || 0;
                const avgB = b.tournamentAverage || 0;
                return avgB - avgA;
            });

            // Render results table
            html += `
                <div class="results-table">
                    <h3>Final Standings</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Bowler</th>
                                <th class="center">Games</th>
                                <th class="center games-cell">Scores</th>
                                <th class="center">Total</th>
                                <th class="center">Average</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            sortedResults.forEach((result, index) => {
                const rank = index + 1;
                const podiumClass = rank <= 3 ? `podium-${rank}` : '';
                const rankClass = rank <= 3 ? `rank-${rank}` : '';

                // Collect all games from all squads
                const allGames = [];
                if (result.squadResults) {
                    result.squadResults.forEach(sr => {
                        if (sr.games) allGames.push(...sr.games);
                    });
                }

                const totalPins = allGames.reduce((sum, g) => sum + g, 0);
                const gameCount = allGames.length;
                const average = gameCount > 0 ? Math.round(totalPins / gameCount) : 0;

                html += `
                    <tr class="${podiumClass}">
                        <td class="rank-cell ${rankClass}">${rank}</td>
                        <td class="bowler-name">
                            <a href="/playerstats?id=${result.bowlerId}">${result.bowlerName}</a>
                        </td>
                        <td class="center">${gameCount}</td>
                        <td class="center games-cell">${allGames.join(', ')}</td>
                        <td class="center total-cell">${totalPins}</td>
                        <td class="center avg-cell">${average}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function filterBySquad(squadId) {
            currentSquadFilter = squadId;
            // TODO: Implement squad filtering if needed
            renderResults();
        }

        init();
    </script>
</body>
</html>
